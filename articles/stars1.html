<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>1. introduction • stars</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="1. introduction">
<meta property="og:description" content="stars">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">stars</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.5-4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/stars1.html">1. introduction</a>
    </li>
    <li>
      <a href="../articles/stars2.html">2. stars proxy objects</a>
    </li>
    <li>
      <a href="../articles/stars3.html">3. stars tidyverse methods</a>
    </li>
    <li>
      <a href="../articles/stars4.html">4. stars data model</a>
    </li>
    <li>
      <a href="../articles/stars5.html">5. vector-raster conversions, reprojection, warping</a>
    </li>
    <li>
      <a href="../articles/stars6.html">6. How `raster` functions map to `stars` functions</a>
    </li>
    <li>
      <a href="../articles/stars7.html">7. Statistical modelling with stars objects</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-spatial/stars/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="stars1_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>1. introduction</h1>
                        <h4 class="author">Edzer Pebesma</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-spatial/stars/blob/master/vignettes/stars1.Rmd"><code>vignettes/stars1.Rmd</code></a></small>
      <div class="hidden name"><code>stars1.Rmd</code></div>

    </div>

    
    
<p>Package <code>stars</code> provides infrastructure for <em>data cubes</em>, array data with labeled dimensions, with emphasis on arrays where some of the dimensions relate to time and/or space.</p>
<p>Spatial data cubes are arrays with one or more spatial dimensions. Raster data cubes have at least two spatial dimensions that form the raster tesselation. Vector data cubes have at least one spatial dimension that may for instance reflect a polygon tesselation, or a set of point locations. Conversions between the two (rasterization, polygonization) are provided. Vector data are represented by simple feature geometries (packages <code>sf</code>). Tidyverse methods are provided.</p>
<p>The <code>stars</code> package is loaded by</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span>
<span class="co">## Loading required package: abind</span>
<span class="co">## Loading required package: sf</span>
<span class="co">## Linking to GEOS 3.8.0, GDAL 3.0.4, PROJ 6.3.1</span></code></pre></div>
<p>Spatiotemporal arrays are stored in objects of class <code>stars</code>; methods for class <code>stars</code> currently available are</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span>
<span class="co">##  [1] [                 [[&lt;-              [&lt;-               %in%             </span>
<span class="co">##  [5] $&lt;-               adrop             aggregate         aperm            </span>
<span class="co">##  [9] as.data.frame     c                 coerce            contour          </span>
<span class="co">## [13] cut               dim               dimnames          dimnames&lt;-       </span>
<span class="co">## [17] droplevels        filter            hist              image            </span>
<span class="co">## [21] initialize        is.na             Math              merge            </span>
<span class="co">## [25] Ops               plot              predict           print            </span>
<span class="co">## [29] show              slotsFromS3       split             st_apply         </span>
<span class="co">## [33] st_area           st_as_sf          st_as_sfc         st_as_stars      </span>
<span class="co">## [37] st_bbox           st_coordinates    st_crop           st_crs           </span>
<span class="co">## [41] st_crs&lt;-          st_dimensions     st_dimensions&lt;-   st_extract       </span>
<span class="co">## [45] st_geometry       st_interpolate_aw st_intersects     st_join          </span>
<span class="co">## [49] st_mosaic         st_normalize      st_redimension    st_sample        </span>
<span class="co">## [53] st_set_bbox       st_transform_proj st_transform      write_stars      </span>
<span class="co">## see '?methods' for accessing help and source code</span></code></pre></div>
<p>(tidyverse methods are only visible after loading package <code>tidyverse</code>).</p>
<div id="reading-a-satellite-image" class="section level1">
<h1 class="hasAnchor">
<a href="#reading-a-satellite-image" class="anchor"></a>Reading a satellite image</h1>
<p>We can read a satellite image through GDAL, e.g. from a GeoTIFF file in the package:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tif</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span>
<span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">x</span>, axes <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<p><img src="stars1_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
<p>We see that the image is geographically referenced (has coordinate values along axes), and that the object returned (<code>x</code>) has three dimensions called <code>x</code>, <code>y</code> and <code>band</code>, and has one attribute:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span>
<span class="co">## stars object with 3 dimensions and 1 attribute</span>
<span class="co">## attribute(s):</span>
<span class="co">##              Min. 1st Qu. Median     Mean 3rd Qu. Max.</span>
<span class="co">## L7_ETMs.tif     1      54     69 68.91242      86  255</span>
<span class="co">## dimension(s):</span>
<span class="co">##      from  to  offset delta                       refsys point values x/y</span>
<span class="co">## x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]</span>
<span class="co">## y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</span>
<span class="co">## band    1   6      NA    NA                           NA    NA   NULL</span></code></pre></div>
<p>Each dimension has a name; the meaning of the fields of a single dimension are:</p>
<table class="table">
<colgroup>
<col width="11%">
<col width="88%">
</colgroup>
<thead><tr class="header">
<th><em>field</em></th>
<th><em>meaning</em></th>
</tr></thead>
<tbody>
<tr class="odd">
<td>from</td>
<td>the origin index (1)</td>
</tr>
<tr class="even">
<td>to</td>
<td>the final index (dim(x)[i])</td>
</tr>
<tr class="odd">
<td>offset</td>
<td>the start value for this dimension (pixel boundary), if regular</td>
</tr>
<tr class="even">
<td>delta</td>
<td>the step (pixel, cell) size for this dimension, if regular</td>
</tr>
<tr class="odd">
<td>refsys</td>
<td>the reference system, or proj4string</td>
</tr>
<tr class="even">
<td>point</td>
<td>logical; whether cells refer to points, or intervals</td>
</tr>
<tr class="odd">
<td>values</td>
<td>the sequence of values for this dimension (e.g., geometries), if irregular</td>
</tr>
</tbody>
</table>
<p>This means that for an index i (starting at <span class="math inline">\(i=1\)</span>) along a certain dimension, the corresponding dimension value (coordinate, time) is <span class="math inline">\(\mbox{offset} + (i-1) \times \mbox{delta}\)</span>. This value then refers to the start (edge) of the cell or interval; in order to get the interval middle or cell centre, one needs to add half an offset.</p>
<p>Dimension <code>band</code> is a simple sequence from 1 to 6. Since bands refer to colors, one could put their wavelength values in the <code>values</code> field.</p>
<p>For this particular dataset (and most other raster datasets), we see that offset for dimension <code>y</code> is negative: this means that consecutive array values have decreasing <span class="math inline">\(y\)</span> values: cell indexes increase from top to bottom, in the direction opposite to the <span class="math inline">\(y\)</span> axis.</p>
<p><code>read_stars</code> reads all bands from a raster dataset, or optionally a subset of raster datasets, into a single <code>stars</code> array structure. While doing so, raster values (often UINT8 or UINT16) are converted to double (numeric) values, and scaled back to their original values if needed if the file encodes the scaling parameters.</p>
<p>The data structure <code>stars</code> is a generalisation of the <code>tbl_cube</code> found in <code>cubelyr</code>; we can convert to that by</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/cubelyr">cubelyr</a></span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/cubelyr/man/as.tbl_cube.html">as.tbl_cube</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="co">## Source: local array [737,088 x 3]</span>
<span class="co">## D: x [dbl, 349]</span>
<span class="co">## D: y [dbl, 352]</span>
<span class="co">## D: band [int, 6]</span>
<span class="co">## M: L7_ETMs.tif [dbl[,352,6]]</span></code></pre></div>
<p>but this will cause a loss of certain properties (cell size, reference system, vector geometries)</p>
<div id="switching-attributes-to-dimensions-and-back" class="section level2">
<h2 class="hasAnchor">
<a href="#switching-attributes-to-dimensions-and-back" class="anchor"></a>Switching attributes to dimensions and back</h2>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="op">(</span><span class="va">x.spl</span> <span class="op">=</span> <span class="fu"><a href="../reference/merge.html">split</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"band"</span><span class="op">)</span><span class="op">)</span>
<span class="co">## stars object with 2 dimensions and 6 attributes</span>
<span class="co">## attribute(s):</span>
<span class="co">##     Min. 1st Qu. Median     Mean 3rd Qu. Max.</span>
<span class="co">## X1    47      67     78 79.14772      89  255</span>
<span class="co">## X2    32      55     66 67.57465      79  255</span>
<span class="co">## X3    21      49     63 64.35886      77  255</span>
<span class="co">## X4     9      52     63 59.23541      75  255</span>
<span class="co">## X5     1      63     89 83.18266     112  255</span>
<span class="co">## X6     1      32     60 59.97521      88  255</span>
<span class="co">## dimension(s):</span>
<span class="co">##   from  to  offset delta                       refsys point values x/y</span>
<span class="co">## x    1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]</span>
<span class="co">## y    1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</span>
<span class="fu"><a href="../reference/merge.html">merge</a></span><span class="op">(</span><span class="va">x.spl</span><span class="op">)</span>
<span class="co">## stars object with 3 dimensions and 1 attribute</span>
<span class="co">## attribute(s):</span>
<span class="co">##    Min. 1st Qu. Median     Mean 3rd Qu. Max.</span>
<span class="co">## X     1      54     69 68.91242      86  255</span>
<span class="co">## dimension(s):</span>
<span class="co">##            from  to  offset delta                       refsys point    values</span>
<span class="co">## x             1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE      NULL</span>
<span class="co">## y             1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE      NULL</span>
<span class="co">## attributes    1   6      NA    NA                           NA    NA X1,...,X6</span>
<span class="co">##            x/y</span>
<span class="co">## x          [x]</span>
<span class="co">## y          [y]</span>
<span class="co">## attributes</span></code></pre></div>
<p>We see that the newly created dimension lost its name, and the single attribute got a default name. We can set attribute names with <code>setNames</code>, and dimension names and values with <code>st_set_dimensions</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/merge.html">merge</a></span><span class="op">(</span><span class="va">x.spl</span><span class="op">)</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/st_dimensions.html">st_set_dimensions</a></span><span class="op">(</span><span class="fl">3</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"band"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">6</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="../reference/st_dimensions.html">st_set_dimensions</a></span><span class="op">(</span>names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span>, <span class="st">"band"</span><span class="op">)</span><span class="op">)</span>
<span class="co">## stars object with 3 dimensions and 1 attribute</span>
<span class="co">## attribute(s):</span>
<span class="co">##              Min. 1st Qu. Median     Mean 3rd Qu. Max.</span>
<span class="co">## L7_ETMs.tif     1      54     69 68.91242      86  255</span>
<span class="co">## dimension(s):</span>
<span class="co">##      from  to  offset delta                       refsys point          values</span>
<span class="co">## x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE            NULL</span>
<span class="co">## y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE            NULL</span>
<span class="co">## band    1   6      NA    NA                           NA    NA band1,...,band6</span>
<span class="co">##      x/y</span>
<span class="co">## x    [x]</span>
<span class="co">## y    [y]</span>
<span class="co">## band</span></code></pre></div>
</div>
<div id="subsetting" class="section level2">
<h2 class="hasAnchor">
<a href="#subsetting" class="anchor"></a>Subsetting</h2>
<p>Besides the <code>tidyverse</code> subsetting and selection operators explained in <a href="stars3.html">this vignette</a>, we can also use <code><a href="https://rdrr.io/r/base/Extract.html">[</a></code> and <code><a href="https://rdrr.io/r/base/Extract.html">[[</a></code>.</p>
<p>Since <code>stars</code> objects are a list of <code>array</code>s with a metadata table describing dimensions, list extraction (and assignment) works as expected:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="co">## [1] "array"</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>
<span class="co">##    x    y band </span>
<span class="co">##  349  352    6</span>
<span class="va">x</span><span class="op">$</span><span class="va">two</span> <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">x</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>
<span class="va">x</span>
<span class="co">## stars object with 3 dimensions and 2 attributes</span>
<span class="co">## attribute(s):</span>
<span class="co">##              Min. 1st Qu. Median      Mean 3rd Qu. Max.</span>
<span class="co">## L7_ETMs.tif     1      54     69  68.91242      86  255</span>
<span class="co">## two             2     108    138 137.82484     172  510</span>
<span class="co">## dimension(s):</span>
<span class="co">##      from  to  offset delta                       refsys point values x/y</span>
<span class="co">## x       1 349  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]</span>
<span class="co">## y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</span>
<span class="co">## band    1   6      NA    NA                           NA    NA   NULL</span></code></pre></div>
<p>At this level, we can work with <code>array</code> objects directly.</p>
<p>The <code>stars</code> subset operator <code><a href="https://rdrr.io/r/base/Extract.html">[</a></code> works a bit different: its</p>
<ul>
<li>first argument selects attributes</li>
<li>second argument selects the first dimension</li>
<li>third argument selects the second dimension, etc</li>
</ul>
<p>Thus,</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span><span class="op">[</span><span class="st">"two"</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">10</span>, , <span class="fl">2</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span>
<span class="co">## stars object with 3 dimensions and 1 attribute</span>
<span class="co">## attribute(s):</span>
<span class="co">##      Min. 1st Qu. Median     Mean 3rd Qu. Max.</span>
<span class="co">## two    36     100    116 119.7326     136  470</span>
<span class="co">## dimension(s):</span>
<span class="co">##      from  to  offset delta                       refsys point values x/y</span>
<span class="co">## x       1  10  288776  28.5 UTM Zone 25, Southern Hem... FALSE   NULL [x]</span>
<span class="co">## y       1 352 9120761 -28.5 UTM Zone 25, Southern Hem... FALSE   NULL [y]</span>
<span class="co">## band    2   4      NA    NA                           NA    NA   NULL</span></code></pre></div>
<p>selects the second attribute, the first 10 columns (x-coordinate), all rows, and bands 2-4.</p>
<p>Alternatively, when <code><a href="https://rdrr.io/r/base/Extract.html">[</a></code> is given a single argument of class <code>sf</code>, <code>sfc</code> or <code>bbox</code>, <code><a href="https://rdrr.io/r/base/Extract.html">[</a></code> will work as a crop operator:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">circle</span> <span class="op">=</span> <span class="fu">st_sfc</span><span class="op">(</span><span class="fu">st_buffer</span><span class="op">(</span><span class="fu">st_point</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">293749.5</span>, <span class="fl">9115745</span><span class="op">)</span><span class="op">)</span>, <span class="fl">400</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fu">st_crs</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">circle</span><span class="op">]</span><span class="op">[</span>, , , <span class="fl">1</span><span class="op">]</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">circle</span>, col <span class="op">=</span> <span class="cn">NA</span>, border <span class="op">=</span> <span class="st">'red'</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, lwd <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p><img src="stars1_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
</div>
<div id="overviews" class="section level2">
<h2 class="hasAnchor">
<a href="#overviews" class="anchor"></a>Overviews</h2>
<p>We can read rasters at a lower resolution when they contain so-called overviews. For this GeoTIFF file, they were created with the <code>gdaladdo</code> utility, in particular</p>
<pre><code>gdaladdo -r average L7_ETMs.tif  2 4 8 16</code></pre>
<p>which adds coarse resolution versions by using the <em>average</em> resampling method to compute values based on blocks of pixels. These can be read by</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x1</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span>, options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"OVERVIEW_LEVEL=1"</span><span class="op">)</span><span class="op">)</span>
<span class="va">x2</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span>, options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"OVERVIEW_LEVEL=2"</span><span class="op">)</span><span class="op">)</span>
<span class="va">x3</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span>, options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"OVERVIEW_LEVEL=3"</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x1</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x2</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x3</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span><span class="op">)</span>, mar <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span><span class="op">(</span><span class="va">x1</span><span class="op">[</span>,,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span><span class="op">(</span><span class="va">x2</span><span class="op">[</span>,,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/graphics/image.html">image</a></span><span class="op">(</span><span class="va">x3</span><span class="op">[</span>,,,<span class="fl">1</span><span class="op">]</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="reading-a-raster-time-series-netcdf" class="section level1">
<h1 class="hasAnchor">
<a href="#reading-a-raster-time-series-netcdf" class="anchor"></a>Reading a raster time series: NetCDF</h1>
<p>Another example is when we read raster time series model outputs in a NetCDF file, e.g. by</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"nc/bcsd_obs_1999.nc"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">w</span>
<span class="co">## pr, tas,</span></code></pre></div>
<p>We see that</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">w</span>
<span class="co">## stars object with 3 dimensions and 2 attributes</span>
<span class="co">## attribute(s):</span>
<span class="co">##                 Min.   1st Qu.   Median      Mean   3rd Qu.      Max. NA's</span>
<span class="co">## pr [mm/m]  0.5900000 56.139999 81.88000 101.26433 121.07250 848.54999 7116</span>
<span class="co">## tas [C]   -0.4209678  8.898887 15.65763  15.48932  21.77979  29.38581 7116</span>
<span class="co">## dimension(s):</span>
<span class="co">##      from to offset  delta  refsys point                    values x/y</span>
<span class="co">## x       1 81    -85  0.125      NA    NA                      NULL [x]</span>
<span class="co">## y       1 33 37.125 -0.125      NA    NA                      NULL [y]</span>
<span class="co">## time    1 12     NA     NA POSIXct    NA 1999-01-31,...,1999-12-31</span></code></pre></div>
<p>For this dataset we can see that</p>
<ul>
<li>variables have units associated (and a wrong unit, <code>C</code> is assigned to temperature)</li>
<li>time is now a dimension, with proper units and time steps</li>
</ul>
<p>Alternatively, this dataset can be read using <code>read_ncdf</code>, as in</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"nc/bcsd_obs_1999.nc"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="../reference/read_ncdf.html">read_ncdf</a></span><span class="op">(</span><span class="op">)</span>
<span class="co">## no 'var' specified, using pr, tas</span>
<span class="co">## other available variables:</span>
<span class="co">##  latitude, longitude, time</span>
<span class="co">## No projection information found in nc file. </span>
<span class="co">##  Coordinate variable units found to be degrees, </span>
<span class="co">##  assuming WGS84 Lat/Lon.</span>
<span class="co">## stars object with 3 dimensions and 2 attributes</span>
<span class="co">## attribute(s):</span>
<span class="co">##                 Min.   1st Qu.   Median      Mean   3rd Qu.      Max. NA's</span>
<span class="co">## pr [mm/m]  0.5900000 56.139999 81.88000 101.26433 121.07250 848.54999 7116</span>
<span class="co">## tas [C]   -0.4209678  8.898887 15.65763  15.48932  21.77979  29.38581 7116</span>
<span class="co">## dimension(s):</span>
<span class="co">##           from to offset delta  refsys point                    values x/y</span>
<span class="co">## longitude    1 81    -85 0.125  WGS 84    NA                      NULL [x]</span>
<span class="co">## latitude     1 33     33 0.125  WGS 84    NA                      NULL [y]</span>
<span class="co">## time         1 12     NA    NA POSIXct    NA 1999-01-31,...,1999-12-31</span></code></pre></div>
<p>The difference between <code>read_ncdf</code> and <code>read_stars</code> for NetCDF files is that the former uses package RNetCDF to directly read the NetCDF file, where the latter uses the GDAL driver for NetCDF files.</p>
<div id="reading-datasets-from-multiple-files" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-datasets-from-multiple-files" class="anchor"></a>Reading datasets from multiple files</h2>
<p>Model data are often spread across many files. An example of a 0.25 degree grid, global daily sea surface temperature product is found <a href="ftp://ftp.cdc.noaa.gov/Datasets/noaa.oisst.v2.highres/">here</a>; the subset from 1981 used below was downloaded from a NOAA ftp site that is no longer available in this form. (ftp site used to be eclipse.ncdc.noaa.gov/pub/OI-daily-v2/NetCDF/1981/AVHRR/).</p>
<p>We read the data by giving <code>read_stars</code> a vector with character names:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
<span class="st">"avhrr-only-v2.19810901.nc"</span>,
<span class="st">"avhrr-only-v2.19810902.nc"</span>,
<span class="st">"avhrr-only-v2.19810903.nc"</span>,
<span class="st">"avhrr-only-v2.19810904.nc"</span>,
<span class="st">"avhrr-only-v2.19810905.nc"</span>,
<span class="st">"avhrr-only-v2.19810906.nc"</span>,
<span class="st">"avhrr-only-v2.19810907.nc"</span>,
<span class="st">"avhrr-only-v2.19810908.nc"</span>,
<span class="st">"avhrr-only-v2.19810909.nc"</span>
<span class="op">)</span>
<span class="co"># see the second vignette:</span>
<span class="co"># install.packages("starsdata", repos = "http://pebesma.staff.ifgi.de", type = "source")</span>
<span class="va">file_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"netcdf/"</span>, <span class="va">x</span><span class="op">)</span>, package <span class="op">=</span> <span class="st">"starsdata"</span><span class="op">)</span>
<span class="op">(</span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">file_list</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="co">## stars object with 4 dimensions and 4 attributes</span>
<span class="co">## attribute(s), summary of first 1e+05 cells:</span>
<span class="co">##                Min. 1st Qu. Median       Mean 3rd Qu. Max.  NA's</span>
<span class="co">## sst [°*C]     -1.80   -1.19  -1.05 -0.3201670   -0.20 9.36 13360</span>
<span class="co">## anom [°*C]    -4.69   -0.06   0.52  0.2299385    0.71 3.70 13360</span>
<span class="co">## err [°*C]      0.11    0.30   0.30  0.2949421    0.30 0.48 13360</span>
<span class="co">## ice [percent]  0.01    0.73   0.83  0.7657695    0.87 1.00 27377</span>
<span class="co">## dimension(s):</span>
<span class="co">##      from   to         offset  delta  refsys point values x/y</span>
<span class="co">## x       1 1440              0   0.25      NA    NA   NULL [x]</span>
<span class="co">## y       1  720             90  -0.25      NA    NA   NULL [y]</span>
<span class="co">## zlev    1    1          0 [m]     NA      NA    NA   NULL    </span>
<span class="co">## time    1    9 1981-09-01 UTC 1 days POSIXct    NA   NULL</span></code></pre></div>
<p>Next, we select sea surface temperature (<code>sst</code>), and drop the singular <code>zlev</code> (depth) dimension using <code>adrop</code>:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="co">## </span>
<span class="co">## Attaching package: 'dplyr'</span>
<span class="co">## The following objects are masked from 'package:stats':</span>
<span class="co">## </span>
<span class="co">##     filter, lag</span>
<span class="co">## The following objects are masked from 'package:base':</span>
<span class="co">## </span>
<span class="co">##     intersect, setdiff, setequal, union</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">abind</span><span class="op">)</span>
<span class="va">z</span> <span class="op">&lt;-</span> <span class="va">y</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">sst</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/abind/man/adrop.html">adrop</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>We can now graph the sea surface temperature (SST) using <code>ggplot</code>, which needs data in a long table form, and without units:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># convert POSIXct time to character, to please ggplot's facet_wrap()</span>
<span class="va">z1</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_dimensions.html">st_set_dimensions</a></span><span class="op">(</span><span class="va">z</span>, <span class="fl">3</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span><span class="op">(</span><span class="fu"><a href="../reference/st_dimensions.html">st_get_dimension_values</a></span><span class="op">(</span><span class="va">z</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/">viridis</a></span><span class="op">)</span>
<span class="co">## Loading required package: viridisLite</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jrnold/ggthemes">ggthemes</a></span><span class="op">)</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>  
  <span class="fu"><a href="../reference/geom_stars.html">geom_stars</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">z1</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, alpha <span class="op">=</span> <span class="fl">0.8</span>, downsample <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">10</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html">facet_wrap</a></span><span class="op">(</span><span class="st">"time"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html">scale_fill_viridis</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html">coord_equal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://rdrr.io/pkg/ggthemes/man/theme_map.html">theme_map</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.key.width <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/grid/unit.html">unit</a></span><span class="op">(</span><span class="fl">2</span>, <span class="st">"cm"</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="stars1_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
</div>
</div>
<div id="writing-stars-objects-to-disk" class="section level1">
<h1 class="hasAnchor">
<a href="#writing-stars-objects-to-disk" class="anchor"></a>Writing stars objects to disk</h1>
<p>We can write a stars object to disk by using <code>write_stars</code>; this used the GDAL write engine. Writing NetCDF files without going through the GDAL interface is currently not supported. <code>write_stars</code> currently writes only a single attribute:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="../reference/write_stars.html">write_stars</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/abind/man/adrop.html">adrop</a></span><span class="op">(</span><span class="va">y</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>, <span class="st">"sst.tif"</span><span class="op">)</span></code></pre></div>
<p>See the explanation of <code>merge</code> above to see how multiple attributes can be merged (folded) into a dimension.</p>
</div>
<div id="cropping-a-rasters-extent" class="section level1">
<h1 class="hasAnchor">
<a href="#cropping-a-rasters-extent" class="anchor"></a>Cropping a raster’s extent</h1>
<p>Using a curvilinear grid, taken from the example of <code>read_ncdf</code>:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prec_file</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"nc/test_stageiv_xyt.nc"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span>
<span class="va">prec</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_ncdf.html">read_ncdf</a></span><span class="op">(</span><span class="va">prec_file</span>, curvilinear <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"lon"</span>, <span class="st">"lat"</span><span class="op">)</span><span class="op">)</span>
<span class="co">## no 'var' specified, using Total_precipitation_surface_1_Hour_Accumulation</span>
<span class="co">## other available variables:</span>
<span class="co">##  time_bounds, lon, lat, time</span>
<span class="co">## No projection information found in nc file. </span>
<span class="co">##  Coordinate variable units found to be degrees, </span>
<span class="co">##  assuming WGS84 Lat/Lon.</span>
<span class="co">## Warning in .get_nc_dimensions(dimensions, coord_var = all_coord_var, coords =</span>
<span class="co">## coords, : bounds for time seem to be reversed; reverting them</span>
<span class="co">##plot(prec) ## gives error about unique breaks</span>
<span class="co">## remove NAs, zeros, and give a large number</span>
<span class="co">## of breaks (used for validating in detail)</span>
<span class="va">qu_0_omit</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span>, <span class="va">n</span> <span class="op">=</span> <span class="fl">22</span><span class="op">)</span> <span class="op">{</span>
  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html">inherits</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"units"</span><span class="op">)</span><span class="op">)</span>
    <span class="va">x</span> <span class="op">=</span> <span class="fu">units</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/units/man/drop_units.html">drop_units</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>
  <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="va">x</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">]</span>, <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span>, length.out <span class="op">=</span> <span class="va">n</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span> <span class="co"># loads slice generic</span>
<span class="va">prec_slice</span> <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="va">prec</span>, index <span class="op">=</span> <span class="fl">17</span>, along <span class="op">=</span> <span class="st">"time"</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">prec_slice</span>, border <span class="op">=</span> <span class="cn">NA</span>, breaks <span class="op">=</span> <span class="fu">qu_0_omit</span><span class="op">(</span><span class="va">prec_slice</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">nc</span> <span class="op">=</span> <span class="fu">sf</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">read_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"gpkg/nc.gpkg"</span>, package <span class="op">=</span> <span class="st">"sf"</span><span class="op">)</span>, <span class="st">"nc.gpkg"</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="fu">st_geometry</span><span class="op">(</span><span class="va">nc</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, reset <span class="op">=</span> <span class="cn">FALSE</span>, col <span class="op">=</span> <span class="cn">NA</span>, border <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></code></pre></div>
<p><img src="stars1_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<p>We can now crop the grid to those cells falling in</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nc</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">nc</span>, <span class="fu">st_crs</span><span class="op">(</span><span class="va">prec_slice</span><span class="op">)</span><span class="op">)</span> <span class="co"># datum transformation</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">prec_slice</span><span class="op">[</span><span class="va">nc</span><span class="op">]</span>, border <span class="op">=</span> <span class="cn">NA</span>, breaks <span class="op">=</span> <span class="fu">qu_0_omit</span><span class="op">(</span><span class="va">prec_slice</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="fu">st_geometry</span><span class="op">(</span><span class="va">nc</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, reset <span class="op">=</span> <span class="cn">FALSE</span>, col <span class="op">=</span> <span class="cn">NA</span>, border <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></code></pre></div>
<p><img src="stars1_files/figure-html/unnamed-chunk-20-1.png" width="700"></p>
<p>The selection <code>prec_slice[nc]</code> essentially calls <code><a href="../reference/st_crop.html">st_crop(prec_slice, nc)</a></code> to get a cropped selection. What happened here is that all cells not intersecting with North Carolina (sea) are set to <code>NA</code> values. For regular grids, the extent of the resulting <code>stars</code> object is also be reduced (cropped) by default; this can be controlled with the <code>crop</code> parameter to <code>st_crop</code> and <code>[.stars</code>.</p>
</div>
<div id="vector-data-cube-example" class="section level1">
<h1 class="hasAnchor">
<a href="#vector-data-cube-example" class="anchor"></a>Vector data cube example</h1>
<p>Like <code>tbl_cube</code>, <code>stars</code> arrays have no limits to the number of dimensions they handle. An example is the origin-destination (OD) matrix, by time and travel mode.</p>
<div id="od-space-x-space-x-travel-mode-x-time-x-time" class="section level2">
<h2 class="hasAnchor">
<a href="#od-space-x-space-x-travel-mode-x-time-x-time" class="anchor"></a>OD: space x space x travel mode x time x time</h2>
<p>We create a 5-dimensional matrix of traffic between regions, by day, by time of day, and by travel mode. Having day and time of day each as dimension is an advantage when we want to compute patterns over the day, for a certain period.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nc</span> <span class="op">=</span> <span class="fu">st_read</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"gpkg/nc.gpkg"</span>, package<span class="op">=</span><span class="st">"sf"</span><span class="op">)</span><span class="op">)</span> 
<span class="co">## Reading layer `nc.gpkg' from data source </span>
<span class="co">##   `/home/runner/work/_temp/Library/sf/gpkg/nc.gpkg' using driver `GPKG'</span>
<span class="co">## Simple feature collection with 100 features and 14 fields</span>
<span class="co">## Geometry type: MULTIPOLYGON</span>
<span class="co">## Dimension:     XY</span>
<span class="co">## Bounding box:  xmin: -84.32385 ymin: 33.88199 xmax: -75.45698 ymax: 36.58965</span>
<span class="co">## Geodetic CRS:  NAD27</span>
<span class="va">to</span> <span class="op">=</span> <span class="va">from</span> <span class="op">=</span> <span class="fu">st_geometry</span><span class="op">(</span><span class="va">nc</span><span class="op">)</span> <span class="co"># 100 polygons: O and D regions</span>
<span class="va">mode</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"car"</span>, <span class="st">"bike"</span>, <span class="st">"foot"</span><span class="op">)</span> <span class="co"># travel mode</span>
<span class="va">day</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">100</span> <span class="co"># arbitrary</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-quantities/units/">units</a></span><span class="op">)</span>
<span class="co">## udunits database from /usr/share/xml/udunits/udunits2.xml</span>
<span class="fu"><a href="https://rdrr.io/pkg/units/man/units.html">units</a></span><span class="op">(</span><span class="va">day</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/units/man/units.html">as_units</a></span><span class="op">(</span><span class="st">"days since 2015-01-01"</span><span class="op">)</span>
<span class="va">hour</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/units/man/units.html">set_units</a></span><span class="op">(</span><span class="fl">0</span><span class="op">:</span><span class="fl">23</span>, <span class="va">h</span><span class="op">)</span> <span class="co"># hour of day</span>
<span class="va">dims</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_dimensions.html">st_dimensions</a></span><span class="op">(</span>origin <span class="op">=</span> <span class="va">from</span>, destination <span class="op">=</span> <span class="va">to</span>, mode <span class="op">=</span> <span class="va">mode</span>, day <span class="op">=</span> <span class="va">day</span>, hour <span class="op">=</span> <span class="va">hour</span><span class="op">)</span>
<span class="op">(</span><span class="va">n</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">dims</span><span class="op">)</span><span class="op">)</span>
<span class="co">##      origin destination        mode         day        hour </span>
<span class="co">##         100         100           3         100          24</span>
<span class="va">traffic</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/array.html">array</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Poisson.html">rpois</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/prod.html">prod</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, <span class="fl">10</span><span class="op">)</span>, dim <span class="op">=</span> <span class="va">n</span><span class="op">)</span> <span class="co"># simulated traffic counts</span>
<span class="op">(</span><span class="va">st</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>traffic <span class="op">=</span> <span class="va">traffic</span><span class="op">)</span>,  dimensions <span class="op">=</span> <span class="va">dims</span><span class="op">)</span><span class="op">)</span>
<span class="co">## stars object with 5 dimensions and 1 attribute</span>
<span class="co">## attribute(s), summary of first 1e+05 cells:</span>
<span class="co">##          Min. 1st Qu. Median    Mean 3rd Qu. Max.</span>
<span class="co">## traffic     0       8     10 9.98405      12   26</span>
<span class="co">## dimension(s):</span>
<span class="co">##             from  to                      offset                       delta</span>
<span class="co">## origin         1 100                          NA                          NA</span>
<span class="co">## destination    1 100                          NA                          NA</span>
<span class="co">## mode           1   3                          NA                          NA</span>
<span class="co">## day            1 100 1 [(days since 2015-01-01)] 1 [(days since 2015-01-01)]</span>
<span class="co">## hour           1  24                       0 [h]                       1 [h]</span>
<span class="co">##              refsys point</span>
<span class="co">## origin        NAD27 FALSE</span>
<span class="co">## destination   NAD27 FALSE</span>
<span class="co">## mode             NA FALSE</span>
<span class="co">## day         udunits FALSE</span>
<span class="co">## hour        udunits FALSE</span>
<span class="co">##                                                                        values</span>
<span class="co">## origin      MULTIPOLYGON (((-81.47276 3...,...,MULTIPOLYGON (((-78.65572 3...</span>
<span class="co">## destination MULTIPOLYGON (((-81.47276 3...,...,MULTIPOLYGON (((-78.65572 3...</span>
<span class="co">## mode                                                         car , bike, foot</span>
<span class="co">## day                                                                      NULL</span>
<span class="co">## hour                                                                     NULL</span></code></pre></div>
<p>This array contains the simple feature geometries of origin and destination so that we can directly plot every slice without additional table joins. If we want to represent such an array as a <code>tbl_cube</code>, the simple feature geometry dimensions need to be replaced by indexes:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">st</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/pkg/cubelyr/man/as.tbl_cube.html">as.tbl_cube</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p>The following demonstrates how <code>dplyr</code> can filter bike travel, and compute mean bike traffic by hour of day:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">b</span> <span class="op">&lt;-</span> <span class="va">st</span> <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://rdrr.io/pkg/cubelyr/man/as.tbl_cube.html">as.tbl_cube</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">mode</span> <span class="op">==</span> <span class="st">"bike"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">hour</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>traffic <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">traffic</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">require</a></span><span class="op">(</span><span class="va"><a href="https://ggforce.data-imaginist.com">ggforce</a></span><span class="op">)</span> <span class="co"># for plotting a units variable</span>
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>  
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">b</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">hour</span>, y <span class="op">=</span> <span class="va">traffic</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Edzer Pebesma.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
