<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>2. stars proxy objects • stars</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="2. stars proxy objects">
<meta property="og:description" content="stars">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">stars</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4-4</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/stars1.html">1. introduction</a>
    </li>
    <li>
      <a href="../articles/stars2.html">2. stars proxy objects</a>
    </li>
    <li>
      <a href="../articles/stars3.html">3. stars tidyverse methods</a>
    </li>
    <li>
      <a href="../articles/stars4.html">4. stars data model</a>
    </li>
    <li>
      <a href="../articles/stars5.html">5. vector-raster conversions, reprojection, warping</a>
    </li>
    <li>
      <a href="../articles/stars6.html">6. How `raster` functions map to `stars` functions</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-spatial/stars/">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="stars2_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>2. stars proxy objects</h1>
                        <h4 class="author">Edzer Pebesma</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-spatial/stars/blob/master/vignettes/stars2.Rmd"><code>vignettes/stars2.Rmd</code></a></small>
      <div class="hidden name"><code>stars2.Rmd</code></div>

    </div>

    
    
<p>When your imagery or array data easily fits a couple of times in R’s working memory (RAM), consider yourself lucky. This document was not written for you. If your imagery is too large, or for other reasons you want to work with smaller chunks of data than the files in which they come, read on about your options. First, we will discuss the low-level interface for this, then the higher level, using stars proxy objects that delay all reading.</p>
<div id="preamble-the-starsdata-package" class="section level1">
<h1 class="hasAnchor">
<a href="#preamble-the-starsdata-package" class="anchor"></a>Preamble: the starsdata package</h1>
<p>To run all of the examples in this vignette, you must install a package with datasets that are too large (1 Gb) to be held in the <code>stars</code> package. They are in a <a href="https://github.com/eddelbuettel/drat">drat repo</a>, installation is done by</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html">install.packages</a></span><span class="op">(</span><span class="st">"starsdata"</span>, repos <span class="op">=</span> <span class="st">"http://gis-bigdata.uni-muenster.de"</span>, type <span class="op">=</span> <span class="st">"source"</span><span class="op">)</span> </pre></div>
</div>
<div id="reading-chunks-change-resolution-select-bands" class="section level1">
<h1 class="hasAnchor">
<a href="#reading-chunks-change-resolution-select-bands" class="anchor"></a>Reading chunks, change resolution, select bands</h1>
<p><code>read_stars</code> has an argument called <code>RasterIO</code> which controls how a GDAL dataset is being read. By default, all pixels and all bands are read in memory. This can consume a lot of time and require a lot of memory. Remember that your file may be compressed, and that pixel values represented in the file by bytes are converted to 8-byte doubles in R.</p>
<p>The reason for using <code>RasterIO</code> for this is that the parameters we use are directly mapped to the GDAL RasterIO function used (after adapting the 1-based offset index in R to 0-based offset in C++).</p>
<div id="reading-a-particular-chunk" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-a-particular-chunk" class="anchor"></a>Reading a particular chunk</h2>
<!-- We can read a (spatially) rectangular chunk of data by -->
<p>An example of using <code>RasterIO</code> is</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span>
<span class="co">## Loading required package: abind</span>
<span class="co">## Loading required package: sf</span>
<span class="co">## Linking to GEOS 3.7.1, GDAL 2.2.3, PROJ 4.9.3</span>
<span class="va">tif</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span>
<span class="va">rasterio</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nXOff <span class="op">=</span> <span class="fl">6</span>, nYOff <span class="op">=</span> <span class="fl">6</span>, nXSize <span class="op">=</span> <span class="fl">100</span>, nYSize <span class="op">=</span> <span class="fl">100</span>, bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span>, RasterIO <span class="op">=</span> <span class="va">rasterio</span><span class="op">)</span><span class="op">)</span>
<span class="co">## stars object with 3 dimensions and 1 attribute</span>
<span class="co">## attribute(s):</span>
<span class="co">##   L7_ETMs.tif    </span>
<span class="co">##  Min.   : 23.00  </span>
<span class="co">##  1st Qu.: 54.00  </span>
<span class="co">##  Median : 63.00  </span>
<span class="co">##  Mean   : 62.06  </span>
<span class="co">##  3rd Qu.: 73.25  </span>
<span class="co">##  Max.   :235.00  </span>
<span class="co">## dimension(s):</span>
<span class="co">##      from  to  offset delta                       refsys point values x/y</span>
<span class="co">## x       6 105  288776  28.5 PROJCS["UTM Zone 25, Sout... FALSE   NULL [x]</span>
<span class="co">## y       6 105 9120761 -28.5 PROJCS["UTM Zone 25, Sout... FALSE   NULL [y]</span>
<span class="co">## band    1   3      NA    NA                           NA    NA   NULL</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="co">##    x    y band </span>
<span class="co">##  100  100    3</span></pre></div>
<p>Compare this to</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="fu"><a href="../reference/st_dimensions.html">st_dimensions</a></span><span class="op">(</span><span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span><span class="op">)</span><span class="op">)</span>
<span class="co">##      from  to  offset delta                       refsys point values x/y</span>
<span class="co">## x       1 349  288776  28.5 PROJCS["UTM Zone 25, Sout... FALSE   NULL [x]</span>
<span class="co">## y       1 352 9120761 -28.5 PROJCS["UTM Zone 25, Sout... FALSE   NULL [y]</span>
<span class="co">## band    1   6      NA    NA                           NA    NA   NULL</span></pre></div>
<p>and we see that</p>
<ul>
<li>the <code>delta</code> values remain the same,</li>
<li>the offset (x/y coordinates of origin) of the grid remain the same</li>
<li>the <code>from</code> and <code>to</code> reflect the new area, and relate to the new <code>delta</code> values</li>
<li>
<code><a href="https://rdrr.io/r/base/dim.html">dim(x)</a></code> reflects the new size, and</li>
<li>only three bands were read</li>
</ul>
</div>
<div id="reading-at-a-different-resolution" class="section level2">
<h2 class="hasAnchor">
<a href="#reading-at-a-different-resolution" class="anchor"></a>Reading at a different resolution</h2>
<p>Reading datasets at a lower (but also higher!) resolution can be done by setting <code>nBufXSize</code> and <code>nBufYSize</code></p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="va">rasterio</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nXOff <span class="op">=</span> <span class="fl">6</span>, nYOff <span class="op">=</span> <span class="fl">6</span>, nXSize <span class="op">=</span> <span class="fl">100</span>, nYSize <span class="op">=</span> <span class="fl">100</span>,
                nBufXSize <span class="op">=</span> <span class="fl">20</span>, nBufYSize <span class="op">=</span> <span class="fl">20</span>, bands <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>
<span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span>, RasterIO <span class="op">=</span> <span class="va">rasterio</span><span class="op">)</span><span class="op">)</span>
<span class="co">## stars object with 3 dimensions and 1 attribute</span>
<span class="co">## attribute(s):</span>
<span class="co">##   L7_ETMs.tif    </span>
<span class="co">##  Min.   : 29.00  </span>
<span class="co">##  1st Qu.: 54.00  </span>
<span class="co">##  Median : 64.00  </span>
<span class="co">##  Mean   : 62.28  </span>
<span class="co">##  3rd Qu.: 73.00  </span>
<span class="co">##  Max.   :107.00  </span>
<span class="co">## dimension(s):</span>
<span class="co">##      from to  offset  delta                       refsys point values x/y</span>
<span class="co">## x       2 21  288776  142.5 PROJCS["UTM Zone 25, Sout... FALSE   NULL [x]</span>
<span class="co">## y       2 21 9120761 -142.5 PROJCS["UTM Zone 25, Sout... FALSE   NULL [y]</span>
<span class="co">## band    1  3      NA     NA                           NA    NA   NULL</span></pre></div>
<p>and we see that in addition:</p>
<ul>
<li>the <code>delta</code> (raster cell size) values have increased a factor 5, because <code>nBufXSize</code> and <code>nBufYSize</code> were set to values a factor 5 smaller than <code>nXSize</code> and <code>nYSize</code>
</li>
<li>the offset coordinates of the grid are still the same</li>
<li>the <code>from</code> and <code>to</code> reflect the new area, but relate to the new <code>delta</code> cell size values</li>
</ul>
<p>We can also read at higher resolution; here we read a 3 x 3 area and blow it up to 100 x 100:</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="va">rasterio</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nXOff <span class="op">=</span> <span class="fl">6</span>, nYOff <span class="op">=</span> <span class="fl">6</span>, nXSize <span class="op">=</span> <span class="fl">3</span>, nYSize <span class="op">=</span> <span class="fl">3</span>,
   nBufXSize <span class="op">=</span> <span class="fl">100</span>, nBufYSize <span class="op">=</span> <span class="fl">100</span>, bands <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>
<span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span>, RasterIO <span class="op">=</span> <span class="va">rasterio</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="co">##   x   y </span>
<span class="co">## 100 100</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></pre></div>
<p><img src="stars2_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>The reason we “see” only three grid cells is that the default sampling method is “nearest neighbour”. We can modify this by</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="va">rasterio</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>nXOff <span class="op">=</span> <span class="fl">6</span>, nYOff <span class="op">=</span> <span class="fl">6</span>, nXSize <span class="op">=</span> <span class="fl">3</span>, nYSize <span class="op">=</span> <span class="fl">3</span>,
   nBufXSize <span class="op">=</span> <span class="fl">100</span>, nBufYSize <span class="op">=</span> <span class="fl">100</span>, bands <span class="op">=</span> <span class="fl">1</span>, resample <span class="op">=</span> <span class="st">"cubic_spline"</span><span class="op">)</span>
<span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span>, RasterIO <span class="op">=</span> <span class="va">rasterio</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/dim.html">dim</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="co">##   x   y </span>
<span class="co">## 100 100</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></pre></div>
<p><img src="stars2_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>The following methods are allowed for parameter <code>resample</code>:</p>
<table class="table">
<colgroup>
<col width="25%">
<col width="75%">
</colgroup>
<thead><tr class="header">
<th><code>resample</code></th>
<th>method used</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>nearest_neighbour</code></td>
<td>Nearest neighbour (default)</td>
</tr>
<tr class="even">
<td><code>bilinear</code></td>
<td>Bilinear (2x2 kernel)</td>
</tr>
<tr class="odd">
<td><code>cubic</code></td>
<td>Cubic Convolution Approximation (4x4 kernel)</td>
</tr>
<tr class="even">
<td><code>cubic_spline</code></td>
<td>Cubic B-Spline Approximation (4x4 kernel)</td>
</tr>
<tr class="odd">
<td><code>lanczos</code></td>
<td>Lanczos windowed sinc interpolation (6x6 kernel)</td>
</tr>
<tr class="even">
<td><code>average</code></td>
<td>Average</td>
</tr>
<tr class="odd">
<td><code>mode</code></td>
<td>Mode (selects the value which appears most often of all the sampled points)</td>
</tr>
<tr class="even">
<td><code>Gauss</code></td>
<td>Gauss blurring</td>
</tr>
</tbody>
</table>
<p>All these methods are implemented in GDAL; for what these methods exactly do, we refer to the GDAL documentation or source code.</p>
</div>
</div>
<div id="stars-proxy-objects" class="section level1">
<h1 class="hasAnchor">
<a href="#stars-proxy-objects" class="anchor"></a>Stars proxy objects</h1>
<p>Stars proxy objects take another approach: upon creation they contain no data at all, but only pointers to where the data can be read. Data is only read when it is needed, and only as much as is needed: if we plot a proxy objects, the data are read at the resolution of pixels on the screen, rather than at the native resolution, so that if we have e.g. a 10000 x 10000 Sentinel 2 (level 1C) image, we can open it by</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="va">granule</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"sentinel/S2A_MSIL1C_20180220T105051_N0206_R051_T32ULE_20180221T134037.zip"</span>, package <span class="op">=</span> <span class="st">"starsdata"</span><span class="op">)</span>
<span class="va">s2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"SENTINEL2_L1C:/vsizip/"</span>, <span class="va">granule</span>, <span class="st">"/S2A_MSIL1C_20180220T105051_N0206_R051_T32ULE_20180221T134037.SAFE/MTD_MSIL1C.xml:10m:EPSG_32632"</span><span class="op">)</span>
<span class="op">(</span><span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">s2</span>, proxy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="co">## stars_proxy object with 1 attribute in file:</span>
<span class="co">## $`MTD_MSIL1C.xml:10m:EPSG_32632`</span>
<span class="co">## [1] "[...]/MTD_MSIL1C.xml:10m:EPSG_32632"</span>
<span class="co">## </span>
<span class="co">## dimension(s):</span>
<span class="co">##      from    to offset delta                       refsys point    values x/y</span>
<span class="co">## x       1 10980  3e+05    10 PROJCS["WGS 84 / UTM zone...    NA      NULL [x]</span>
<span class="co">## y       1 10980  6e+06   -10 PROJCS["WGS 84 / UTM zone...    NA      NULL [y]</span>
<span class="co">## band    1     4     NA    NA                           NA    NA B4,...,B8</span></pre></div>
<p>and this happens <em>instantly</em>, because no data is read. When we plot this object,</p>
<div class="sourceCode" id="cb8"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span><span class="op">)</span></pre></div>
<p><img src="stars2_files/figure-html/unnamed-chunk-8-1.png" width="700"></p>
<pre><code>##    user  system elapsed 
##   2.018   0.172   1.858</code></pre>
<p>This takes only around 1 second, since only those pixels are read that can be seen on the plot. If we read the entire image in memory first, as we would do with</p>
<div class="sourceCode" id="cb10"><pre class="downlit">
<span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">s2</span>, proxy <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></pre></div>
<p>then only the reading would take over a minute, and require 5 Gb memory.</p>
<div id="methods-for-stars-proxy-objects" class="section level2">
<h2 class="hasAnchor">
<a href="#methods-for-stars-proxy-objects" class="anchor"></a>Methods for stars proxy objects</h2>
<div class="sourceCode" id="cb11"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/utils/methods.html">methods</a></span><span class="op">(</span>class <span class="op">=</span> <span class="st">"stars_proxy"</span><span class="op">)</span>
<span class="co">##  [1] [              adrop          aggregate      aperm          as.data.frame </span>
<span class="co">##  [6] c              coerce         dim            droplevels     filter        </span>
<span class="co">## [11] initialize     Math           merge          Ops            plot          </span>
<span class="co">## [16] predict        print          show           slotsFromS3    split         </span>
<span class="co">## [21] st_apply       st_as_stars    st_crop        st_extract     st_mosaic     </span>
<span class="co">## [26] st_redimension st_sample      st_set_bbox    write_stars   </span>
<span class="co">## see '?methods' for accessing help and source code</span></pre></div>
</div>
<div id="select-attributes" class="section level2">
<h2 class="hasAnchor">
<a href="#select-attributes" class="anchor"></a>Select attributes</h2>
<p>We can select attributes as with regular <code>stars</code> objects, by using the first argument to <code><a href="https://rdrr.io/r/base/Extract.html">[</a></code>:</p>
<div class="sourceCode" id="cb12"><pre class="downlit">
<span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"avhrr-only-v2.19810901.nc"</span>,
<span class="st">"avhrr-only-v2.19810902.nc"</span>,
<span class="st">"avhrr-only-v2.19810903.nc"</span>,
<span class="st">"avhrr-only-v2.19810904.nc"</span>,
<span class="st">"avhrr-only-v2.19810905.nc"</span>,
<span class="st">"avhrr-only-v2.19810906.nc"</span>,
<span class="st">"avhrr-only-v2.19810907.nc"</span>,
<span class="st">"avhrr-only-v2.19810908.nc"</span>,
<span class="st">"avhrr-only-v2.19810909.nc"</span><span class="op">)</span>
<span class="va">file_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"netcdf/"</span>, <span class="va">x</span><span class="op">)</span>, package <span class="op">=</span> <span class="st">"starsdata"</span><span class="op">)</span>
<span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">file_list</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span>, proxy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>
<span class="co">## [1] "sst"  "anom" "err"  "ice"</span>
<span class="va">y</span><span class="op">[</span><span class="st">"sst"</span><span class="op">]</span>
<span class="co">## stars_proxy object with 1 attribute in files:</span>
<span class="co">## $sst</span>
<span class="co">## [1] "[...]/avhrr-only-v2.19810901.nc:sst" "[...]/avhrr-only-v2.19810902.nc:sst"</span>
<span class="co">## [3] "[...]/avhrr-only-v2.19810903.nc:sst" "[...]/avhrr-only-v2.19810904.nc:sst"</span>
<span class="co">## [5] "[...]/avhrr-only-v2.19810905.nc:sst" "[...]/avhrr-only-v2.19810906.nc:sst"</span>
<span class="co">## [7] "[...]/avhrr-only-v2.19810907.nc:sst" "[...]/avhrr-only-v2.19810908.nc:sst"</span>
<span class="co">## [9] "[...]/avhrr-only-v2.19810909.nc:sst"</span>
<span class="co">## </span>
<span class="co">## dimension(s):</span>
<span class="co">##      from   to         offset  delta  refsys point values x/y</span>
<span class="co">## x       1 1440              0   0.25      NA    NA   NULL [x]</span>
<span class="co">## y       1  720             90  -0.25      NA    NA   NULL [y]</span>
<span class="co">## zlev    1    1          0 [m]     NA      NA    NA   NULL    </span>
<span class="co">## time    1    9 1981-09-01 UTC 1 days POSIXct    NA   NULL</span></pre></div>
<p>Note that this selection limits the reading from 4 to 1 subdataset from all 9 NetCDF files.</p>
</div>
<div id="select-an-area" class="section level2">
<h2 class="hasAnchor">
<a href="#select-an-area" class="anchor"></a>Select an area</h2>
<p>Another possibility is to crop, or select a rectangular region based on a spatial object. This can be done by passing a <code>bbox</code> object, or an <code>sf</code>, <code>sfc</code> or <code>stars</code> object from which the bounding box will be taken. An example:</p>
<div class="sourceCode" id="cb13"><pre class="downlit">
<span class="va">bb</span> <span class="op">=</span> <span class="fu">st_bbox</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="fl">10.125</span>, ymin <span class="op">=</span> <span class="fl">0.125</span>, xmax <span class="op">=</span> <span class="fl">70.125</span>, ymax <span class="op">=</span> <span class="fl">70.125</span><span class="op">)</span><span class="op">)</span>
<span class="va">ysub</span> <span class="op">=</span> <span class="va">y</span><span class="op">[</span><span class="va">bb</span><span class="op">]</span>
<span class="fu"><a href="../reference/st_dimensions.html">st_dimensions</a></span><span class="op">(</span><span class="va">ysub</span><span class="op">)</span>
<span class="co">##      from  to         offset  delta  refsys point values x/y</span>
<span class="co">## x      41 281              0   0.25      NA    NA   NULL [x]</span>
<span class="co">## y      80 360             90  -0.25      NA    NA   NULL [y]</span>
<span class="co">## zlev    1   1          0 [m]     NA      NA    NA   NULL    </span>
<span class="co">## time    1   9 1981-09-01 UTC 1 days POSIXct    NA   NULL</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">ysub</span><span class="op">)</span> <span class="co"># still no data here!!</span>
<span class="co">## [1] "stars_proxy" "stars"</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">ysub</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="co"># plot reads the data, at resolution that is relevant</span>
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="fu">st_as_sfc</span><span class="op">(</span><span class="va">bb</span><span class="op">)</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, lwd <span class="op">=</span> <span class="fl">.5</span>, border <span class="op">=</span> <span class="st">'red'</span><span class="op">)</span></pre></div>
<p><img src="stars2_files/figure-html/unnamed-chunk-12-1.png" width="700"></p>
</div>
<div id="lazy-evaluation-changing-evaluation-order" class="section level2">
<h2 class="hasAnchor">
<a href="#lazy-evaluation-changing-evaluation-order" class="anchor"></a>Lazy evaluation, changing evaluation order</h2>
<p>Some other actions can be carried out on <code>stars_proxy</code> objects, but their effect is delayed until the data are actually needed (<code>plot</code>, <code>write_stars</code>). For instance, range selections on dimensions other than shown above first need data, and can only then be carried out. Such functions are added to the object, in an attribute called <code>call_list</code>:</p>
<div class="sourceCode" id="cb14"><pre class="downlit">
<span class="va">yy</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/abind/man/adrop.html">adrop</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>
<span class="va">yyy</span> <span class="op">=</span> <span class="va">yy</span><span class="op">[</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="fl">1</span><span class="op">:</span><span class="fl">10</span>,<span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">yyy</span><span class="op">)</span> <span class="co"># still no data</span>
<span class="co">## [1] "stars_proxy" "stars"</span>
<span class="fu"><a href="../reference/st_dimensions.html">st_dimensions</a></span><span class="op">(</span><span class="va">yyy</span><span class="op">)</span> <span class="co"># and dimensions not adjusted</span>
<span class="co">##      from to         offset  delta  refsys point values x/y</span>
<span class="co">## x       1 10              0   0.25      NA    NA   NULL [x]</span>
<span class="co">## y       1 10             90  -0.25      NA    NA   NULL [y]</span>
<span class="co">## zlev    1  1          0 [m]     NA      NA    NA   NULL    </span>
<span class="co">## time    1  9 1981-09-01 UTC 1 days POSIXct    NA   NULL</span>
<span class="fu"><a href="https://rdrr.io/r/base/attr.html">attr</a></span><span class="op">(</span><span class="va">yyy</span>, <span class="st">"call_list"</span><span class="op">)</span> <span class="co"># the name of object in the call (y) is replaced with x:</span>
<span class="co">## [[1]]</span>
<span class="co">## x[i = i, drop = drop, crop = crop]</span>
<span class="co">## attr(,".Environment")</span>
<span class="co">## &lt;environment: 0x5626f775e828&gt;</span></pre></div>
<p>Doing this allows for optimizing the order in which operations are done. As an example, for <code>st_apply</code>, reading can be done sequentially over the dimensions over which the function is applied:</p>
<ul>
<li>If for example a function is applied to each band (such as: compute band quantiles), bands can be read sequentially, and discarded after the quantiles have been computed.</li>
<li>If a time series function is applied to pixel time series and the result is plotted on a map, the time series function has only to be evaluated on the pixels actually plotted. This means that in</li>
</ul>
<div class="sourceCode" id="cb15"><pre class="downlit">
<span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/st_apply.html">st_apply</a></span><span class="op">(</span><span class="va">x</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="va">range</span><span class="op">)</span><span class="op">)</span></pre></div>
<p>the order of evaluation needs to be reversed: only <code>plot</code> knows which pixels are going to be shown, so that should be in control of how <code>x</code> is subsampled <em>before</em> <code>st_apply</code> is carried out on this subsample.</p>
<div id="fetching-the-data" class="section level3">
<h3 class="hasAnchor">
<a href="#fetching-the-data" class="anchor"></a>Fetching the data</h3>
<p>Fetching the data now involves reading the whole array and then evaluating the <code>call_list</code> on it, sequentially:</p>
<div class="sourceCode" id="cb16"><pre class="downlit">
<span class="op">(</span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span><span class="va">yyy</span><span class="op">)</span><span class="op">)</span> <span class="co"># read, adrop, subset</span>
<span class="co">## stars object with 4 dimensions and 4 attributes</span>
<span class="co">## attribute(s):</span>
<span class="co">##    sst [°*C]        anom [°*C]      err [°*C]   ice [percent]   </span>
<span class="co">##  Min.   :-1.280   Min.   :0.480   Min.   :0.3   Min.   :0.7600  </span>
<span class="co">##  1st Qu.:-1.170   1st Qu.:0.620   1st Qu.:0.3   1st Qu.:0.7900  </span>
<span class="co">##  Median :-1.110   Median :0.690   Median :0.3   Median :0.8100  </span>
<span class="co">##  Mean   :-1.116   Mean   :0.665   Mean   :0.3   Mean   :0.8063  </span>
<span class="co">##  3rd Qu.:-1.060   3rd Qu.:0.720   3rd Qu.:0.3   3rd Qu.:0.8200  </span>
<span class="co">##  Max.   :-0.950   Max.   :0.770   Max.   :0.3   Max.   :0.8500  </span>
<span class="co">## dimension(s):</span>
<span class="co">##      from to         offset  delta  refsys point values x/y</span>
<span class="co">## x       1 10              0   0.25      NA    NA   NULL [x]</span>
<span class="co">## y       1 10             90  -0.25      NA    NA   NULL [y]</span>
<span class="co">## zlev    1  1          0 [m]     NA      NA    NA   NULL    </span>
<span class="co">## time    1  9 1981-09-01 UTC 1 days POSIXct    NA   NULL</span></pre></div>
</div>
<div id="plotting-with-changed-evaluation-order" class="section level3">
<h3 class="hasAnchor">
<a href="#plotting-with-changed-evaluation-order" class="anchor"></a>Plotting with changed evaluation order</h3>
<p>For the Sentinel 2 data, band 4 represents NIR and band 1 red, so we can compute NDVI by</p>
<div class="sourceCode" id="cb17"><pre class="downlit">
<span class="co"># S2 10m: band 4: near infrared, band 1: red.</span>
<span class="va">ndvi</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">-</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span> <span class="op">+</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/rm.html">rm</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>
<span class="op">(</span><span class="va">s2.ndvi</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_apply.html">st_apply</a></span><span class="op">(</span><span class="va">p</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"x"</span>, <span class="st">"y"</span><span class="op">)</span>, <span class="va">ndvi</span><span class="op">)</span><span class="op">)</span>
<span class="co">## stars_proxy object with 1 attribute in file:</span>
<span class="co">## $`MTD_MSIL1C.xml:10m:EPSG_32632`</span>
<span class="co">## [1] "[...]/MTD_MSIL1C.xml:10m:EPSG_32632"</span>
<span class="co">## </span>
<span class="co">## dimension(s):</span>
<span class="co">##      from    to offset delta                       refsys point    values x/y</span>
<span class="co">## x       1 10980  3e+05    10 PROJCS["WGS 84 / UTM zone...    NA      NULL [x]</span>
<span class="co">## y       1 10980  6e+06   -10 PROJCS["WGS 84 / UTM zone...    NA      NULL [y]</span>
<span class="co">## band    1     4     NA    NA                           NA    NA B4,...,B8    </span>
<span class="co">## call_list:</span>
<span class="co">## [[1]]</span>
<span class="co">## st_apply(X = X, MARGIN = MARGIN, FUN = FUN, .fname = .fname)</span>
<span class="co">## attr(,".Environment")</span>
<span class="co">## &lt;environment: 0x5626f6eaddf0&gt;</span>
<span class="fu"><a href="https://rdrr.io/r/base/system.time.html">system.time</a></span><span class="op">(</span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">s2.ndvi</span><span class="op">)</span><span class="op">)</span> <span class="co"># read - compute ndvi - plot </span></pre></div>
<p><img src="stars2_files/figure-html/unnamed-chunk-16-1.png" width="700"></p>
<pre><code>##    user  system elapsed 
##   1.426   0.136   1.215</code></pre>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Edzer Pebesma.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
