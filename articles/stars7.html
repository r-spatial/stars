<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="stars">
<title>7. Statistical modelling with stars objects • stars</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="7. Statistical modelling with stars objects">
<meta property="og:description" content="stars">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">stars</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6-6</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/stars1.html">1. introduction</a>
    <a class="dropdown-item" href="../articles/stars2.html">2. stars proxy objects</a>
    <a class="dropdown-item" href="../articles/stars3.html">3. stars tidyverse methods</a>
    <a class="dropdown-item" href="../articles/stars4.html">4. stars data model</a>
    <a class="dropdown-item" href="../articles/stars5.html">5. vector-raster conversions, reprojection, warping</a>
    <a class="dropdown-item" href="../articles/stars6.html">6. How `raster` functions map to `stars` functions</a>
    <a class="dropdown-item" href="../articles/stars7.html">7. Statistical modelling with stars objects</a>
    <a class="dropdown-item" href="../articles/stars8.html">8. NetCDF Proxy Workflows</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/r-spatial/stars/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>7. Statistical modelling with stars objects</h1>
                        <h4 data-toc-skip class="author">Edzer
Pebesma</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-spatial/stars/blob/HEAD/vignettes/stars7.Rmd" class="external-link"><code>vignettes/stars7.Rmd</code></a></small>
      <div class="d-none name"><code>stars7.Rmd</code></div>
    </div>

    
    
<p>We will first fix the random number seed, to get identical results
for procedures that involve random sampling. Remove this command if you
want the random effect in outcomes.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">131</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="training-and-prediction-with-stars-objects">Training and prediction with stars objects<a class="anchor" aria-label="anchor" href="#training-and-prediction-with-stars-objects"></a>
</h2>
<p>The usual way of statistical modelling in R uses
<code>data.frame</code>s (or tibbles), and proceeds like</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">m</span> <span class="op">=</span> <span class="fu">model</span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="va">pr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">m</span>, <span class="va">newdata</span><span class="op">)</span></span></code></pre></div>
<p>where <code>model</code> is a function like <code>lm</code>,
<code>glm</code>, <code>randomForest</code> etc. that returns a classed
object, such that the <code>predict</code> generic can choose the right
prediction function based on that class. <code>formula</code> looks like
<code>y ~ x1+x2</code> and specifies the dependent variable
(<code>y</code>) and predictors (<code>x1</code>, <code>x2</code>),
which are found as columns in <code>data</code>. <code>newdata</code>
needs to have the predictors in its columns, and returns the predicted
values for <code>y</code> at these values for predictors.</p>
<div class="section level3">
<h3 id="stars-objects-as-data-frames">stars objects as data.frames<a class="anchor" aria-label="anchor" href="#stars-objects-as-data-frames"></a>
</h3>
<p>The analogy of stars objects to <code>data.frame</code> is this:</p>
<ul>
<li>each attribute (array) becomes a single column</li>
<li>dimensions become added (index) columns</li>
</ul>
<p>To see how this works with the 6-band example dataset, consider
this:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/" class="external-link">stars</a></span><span class="op">)</span></span>
<span><span class="co">## Loading required package: abind</span></span>
<span><span class="co">## Loading required package: sf</span></span>
<span><span class="co">## Linking to GEOS 3.10.2, GDAL 3.4.1, PROJ 8.2.1; sf_use_s2() is TRUE</span></span>
<span><span class="va">l7</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">l7</span></span>
<span><span class="co">## stars object with 3 dimensions and 1 attribute</span></span>
<span><span class="co">## attribute(s):</span></span>
<span><span class="co">##              Min. 1st Qu. Median     Mean 3rd Qu. Max.</span></span>
<span><span class="co">## L7_ETMs.tif     1      54     69 68.91242      86  255</span></span>
<span><span class="co">## dimension(s):</span></span>
<span><span class="co">##      from  to  offset delta                     refsys point x/y</span></span>
<span><span class="co">## x       1 349  288776  28.5 SIRGAS 2000 / UTM zone 25S FALSE [x]</span></span>
<span><span class="co">## y       1 352 9120761 -28.5 SIRGAS 2000 / UTM zone 25S FALSE [y]</span></span>
<span><span class="co">## band    1   6      NA    NA                         NA    NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">l7</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">##          x       y band L7_ETMs.tif</span></span>
<span><span class="co">## 1 288790.5 9120747    1          69</span></span>
<span><span class="co">## 2 288819.0 9120747    1          69</span></span>
<span><span class="co">## 3 288847.5 9120747    1          63</span></span>
<span><span class="co">## 4 288876.0 9120747    1          60</span></span>
<span><span class="co">## 5 288904.5 9120747    1          61</span></span>
<span><span class="co">## 6 288933.0 9120747    1          61</span></span></code></pre></div>
<p>We see that we get <strong>one</strong> single variable with the
object (array) name, and added columns with the dimension values (x, y,
band). In a typical case, we would like to have the six bands
distributed over six variables, and have a single observation (row) for
each x/y pair. For this, we <em>could</em> use
e.g. <code><a href="https://rdrr.io/r/utils/stack.html" class="external-link">utils::unstack</a></code> or <code>dplyr::pivot_wider</code> on
this data.frame, but a more efficient way is to use the dedicated
<code>split</code> method for <code>stars</code> objects, which resolves
a dimension and splits it over attributes, one for each dimension
value:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">l7</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../reference/merge.html">split</a></span><span class="op">(</span><span class="st">"band"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co">##          x       y X1 X2 X3 X4 X5 X6</span></span>
<span><span class="co">## 1 288790.5 9120747 69 56 46 79 86 46</span></span>
<span><span class="co">## 2 288819.0 9120747 69 57 49 75 88 49</span></span>
<span><span class="co">## 3 288847.5 9120747 63 52 45 66 75 41</span></span>
<span><span class="co">## 4 288876.0 9120747 60 45 35 66 69 38</span></span>
<span><span class="co">## 5 288904.5 9120747 61 52 44 76 92 60</span></span>
<span><span class="co">## 6 288933.0 9120747 61 50 37 78 74 38</span></span></code></pre></div>
<p>The reason that <code>split</code> is more efficient than the
mentioned alternatives is that (i) <code>split</code> does not have to
match records based on dimensions (x/y), and (ii) it works for
out-of-memory (stars_proxy) arrays, in the chunked process/write loop of
<code><a href="../reference/write_stars.html">write_stars()</a></code>. ### Predict for <code>stars</code>
objects</p>
<p>The pattern to obtain predictions for all pixels of a
<code>stars</code> objects is:</p>
<ul>
<li>use the full dataset or a sample of it to train the model, using
<code><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame()</a></code> (possibly after a <code>split</code>)</li>
<li>use <code>predict(star_object, model)</code> to predict for all
pixels of <code>stars_object</code>, using the stars-wrapper of the
<code>predict</code> method for <code>model</code>.</li>
<li>if there is no <code>predict</code> method for <code>model</code>,
provide one (see the <code>kmeans</code> example below)</li>
</ul>
<p>This works both for <code>stars</code> objects (in-memory) as
<code>stars_proxy</code> objects (out-of memory). For plotting
<code>stars_proxy</code> objects, downsampling is done <em>before</em>
prediction (predicting only the pixels that are shown), full rasters can
be written to disk with <code><a href="../reference/write_stars.html">write_stars()</a></code>, which will carry out
predictions on chunks being read and written.</p>
</div>
</div>
<div class="section level2">
<h2 id="models-fitted-for-every-pixel">models fitted for every pixel<a class="anchor" aria-label="anchor" href="#models-fitted-for-every-pixel"></a>
</h2>
<p>We can run models in many different ways on array data. One way is to
run a single model to all pixels, where the model operates e.g. on the
spectral (band) or temporal dimension. An example was given <a href="https://r-spatial.github.io/stars/articles/stars2.html#plotting-with-changed-evaluation-order" class="external-link">in
vignette 2</a>, where NDVI was computed from the red and near infrared
band. NDVI does not involve estimating parameters, but reducing two
bands to one.</p>
<p>An example where we fit a model to every pixel would be fit a time
series model to each pixel time series, and output one or more model
coefficients for each pixel; this is shown next.</p>
<div class="section level3">
<h3 id="linear-regression-on-pixel-time-series">Linear regression on pixel time series<a class="anchor" aria-label="anchor" href="#linear-regression-on-pixel-time-series"></a>
</h3>
<p>We can read in the avhrr dataset, containing only 9 days:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/" class="external-link">stars</a></span><span class="op">)</span></span>
<span><span class="va">x</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"avhrr-only-v2.19810901.nc"</span>,</span>
<span><span class="st">"avhrr-only-v2.19810902.nc"</span>,</span>
<span><span class="st">"avhrr-only-v2.19810903.nc"</span>,</span>
<span><span class="st">"avhrr-only-v2.19810904.nc"</span>,</span>
<span><span class="st">"avhrr-only-v2.19810905.nc"</span>,</span>
<span><span class="st">"avhrr-only-v2.19810906.nc"</span>,</span>
<span><span class="st">"avhrr-only-v2.19810907.nc"</span>,</span>
<span><span class="st">"avhrr-only-v2.19810908.nc"</span>,</span>
<span><span class="st">"avhrr-only-v2.19810909.nc"</span><span class="op">)</span></span>
<span><span class="va">file_list</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"netcdf/"</span>, <span class="va">x</span><span class="op">)</span>, package <span class="op">=</span> <span class="st">"starsdata"</span><span class="op">)</span></span>
<span><span class="va">y</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">file_list</span>, sub <span class="op">=</span> <span class="st">"sst"</span>, quiet <span class="op">=</span> <span class="cn">TRUE</span>, proxy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">(</span><span class="va">t</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_dimensions.html">st_get_dimension_values</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">## [1] "1981-09-01 UTC" "1981-09-02 UTC" "1981-09-03 UTC" "1981-09-04 UTC"</span></span>
<span><span class="co">## [5] "1981-09-05 UTC" "1981-09-06 UTC" "1981-09-07 UTC" "1981-09-08 UTC"</span></span>
<span><span class="co">## [9] "1981-09-09 UTC"</span></span></code></pre></div>
<p>We will use a function that computes the slope of the regression line
for temperature with time. We get temperatures as a vector in the first
argument of the function supplied to <code>st_apply</code>, and have
<code>t</code> already defined. The function could look like</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">slope</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="cn">NA_real_</span></span>
<span>  <span class="kw">else</span></span>
<span>    <span class="fu">coeffients</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">x</span><span class="op">~</span><span class="va">t</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>but we will optimize this a bit, using <code>anyNA</code> and
<code>lm.fit</code> rather than <code>lm</code>:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">slope</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">anyNA</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="cn">NA_real_</span></span>
<span>  <span class="kw">else</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/lmfit.html" class="external-link">lm.fit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">t</span><span class="op">)</span>, <span class="va">x</span><span class="op">)</span><span class="op">$</span><span class="va">coefficients</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>The result is lazily defined by (<code>adrop</code> drops the
singular dimension)</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_apply.html">st_apply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/abind/man/adrop.html" class="external-link">adrop</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">)</span>, <span class="va">slope</span><span class="op">)</span></span></code></pre></div>
<p>but only <em>computed</em> by the following command, where the
computations are restricted to the pixels plotted:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">out</span>, breaks <span class="op">=</span> <span class="st">"equal"</span>, main <span class="op">=</span> <span class="st">"9-day time trend (slope)"</span><span class="op">)</span></span>
<span><span class="co">## downsample set to 1</span></span></code></pre></div>
<p><img src="stars7_files/figure-html/unnamed-chunk-10-1.png" width="700"></p>
<p>An interesting pattern appears (despite the very short time series!):
where SST reveals a main signal of colder when getting further from the
equator, <em>changes</em> in SST show much more fine grained structures
of areas going up, and others going down. A diverging color ramp would
be a better choice here, to distinguish positive from negative
trends.</p>
</div>
</div>
<div class="section level2">
<h2 id="unsupervised-learners">Unsupervised learners<a class="anchor" aria-label="anchor" href="#unsupervised-learners"></a>
</h2>
<div class="section level3">
<h3 id="principal-components">Principal components<a class="anchor" aria-label="anchor" href="#principal-components"></a>
</h3>
<p>In the first example, we build principal components on the entire
dataset, because it is rather small.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tif</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">=</span> <span class="fu"><a href="../reference/merge.html">split</a></span><span class="op">(</span><span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pc</span> <span class="op">=</span> <span class="fu"><a href="../reference/prcomp.html">prcomp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="co"># based on all data</span></span>
<span><span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">pc</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/merge.html">merge</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>, breaks <span class="op">=</span> <span class="st">"equal"</span>, join_zlim <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p><img src="stars7_files/figure-html/unnamed-chunk-11-1.png" width="700"></p>
<p>We see, amongst others, that PC1 picks up the difference between sea
(dark) and land, and PC2 and 3 structures in sea and coastal waters.</p>
<p>In the second example, we build principal components from a sample of
the entire dataset, because the entire dataset is rather large. We apply
it, using <code>predict</code>, to pixels shown in the plot (i.e. at
reduced rather than full resolution)</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">granule</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"sentinel/S2A_MSIL1C_20180220T105051_N0206_R051_T32ULE_20180221T134037.zip"</span>, </span>
<span>   package <span class="op">=</span> <span class="st">"starsdata"</span><span class="op">)</span></span>
<span><span class="va">s2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"SENTINEL2_L1C:/vsizip/"</span>, <span class="va">granule</span>, </span>
<span><span class="st">"/S2A_MSIL1C_20180220T105051_N0206_R051_T32ULE_20180221T134037.SAFE/MTD_MSIL1C.xml:10m:EPSG_32632"</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">s2</span>, proxy <span class="op">=</span> <span class="cn">TRUE</span>, NA_value <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/merge.html">split</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html" class="external-link">st_sample</a></span><span class="op">(</span><span class="va">p</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">pc</span> <span class="op">=</span> <span class="fu"><a href="../reference/prcomp.html">prcomp</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span><span class="op">[</span>,<span class="op">-</span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span> <span class="co"># based on all data</span></span>
<span><span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">p</span>, <span class="va">pc</span><span class="op">)</span></span></code></pre></div>
<p>Before plotting this, we’ll add country borders that delineate sea,
obtained from the <code>mapdata</code> package:</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">bb</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fl">4326</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html" class="external-link">st_bbox</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">maps</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">mapdata</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/maps/man/map.html" class="external-link">map</a></span><span class="op">(</span><span class="st">"worldHires"</span>, xlim <span class="op">=</span> <span class="va">bb</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>,<span class="fl">3</span><span class="op">)</span><span class="op">]</span>, ylim <span class="op">=</span> <span class="va">bb</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">2</span>,<span class="fl">4</span><span class="op">)</span><span class="op">]</span>, plot<span class="op">=</span><span class="cn">F</span>,fill<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sfc.html" class="external-link">st_as_sfc</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We plot the results with independent color ranges, so every PC is
stretched over the entire grey scale.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plt_boundary</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">m</span>, border <span class="op">=</span> <span class="st">'orange'</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="../reference/merge.html">merge</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>, hook <span class="op">=</span> <span class="va">plt_boundary</span>, join_zlim <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">## downsample set to 18</span></span></code></pre></div>
<p><img src="stars7_files/figure-html/unnamed-chunk-14-1.png" width="700"></p>
<p>This suggests that PC1 picks up the difference cloud signal
(difference between clouds and non-clouds), PC2 the difference between
sea and land areas, and PC4 some sensor artefacts (striping in swath
direction).</p>
<p>To compute full resolution (10000 x 10000 pixels) results and write
them to a file, use</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/write_stars.html">write_stars</a></span><span class="op">(</span><span class="fu"><a href="../reference/merge.html">merge</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span>, <span class="st">"out.tif"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="k-means-clustering">K-means clustering<a class="anchor" aria-label="anchor" href="#k-means-clustering"></a>
</h3>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">clue</span><span class="op">)</span></span>
<span><span class="va">predict.kmeans</span> <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">unclass</a></span><span class="op">(</span><span class="fu">clue</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/clue/man/cl_predict.html" class="external-link">cl_predict</a></span><span class="op">(</span><span class="va">object</span>, <span class="va">newdata</span><span class="op">[</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span>, <span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>For a small dataset:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tif</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"tif/L7_ETMs.tif"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span></span>
<span><span class="va">i</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">tif</span>, proxy <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/merge.html">split</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">nclus</span> <span class="op">=</span> <span class="fl">5</span></span>
<span></span>
<span><span class="va">sam</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html" class="external-link">st_sample</a></span><span class="op">(</span><span class="va">i</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">k</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">sam</span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, <span class="va">nclus</span><span class="op">)</span></span>
<span><span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">k</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">out</span>, col <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html" class="external-link">sf.colors</a></span><span class="op">(</span><span class="va">nclus</span>, categorical<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="stars7_files/figure-html/unnamed-chunk-17-1.png" width="700"></p>
<p>This seems to pick up a fair number of land cover classes: water (5),
rural (3), and densely populated (1, 2).</p>
<p>For the large(r) dataset:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">i</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">s2</span>, proxy <span class="op">=</span> <span class="cn">TRUE</span>, NA_value <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/merge.html">split</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">sam</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html" class="external-link">st_sample</a></span><span class="op">(</span><span class="va">i</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">k</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/kmeans.html" class="external-link">kmeans</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">sam</span><span class="op">)</span><span class="op">[</span>, <span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, <span class="va">nclus</span><span class="op">)</span></span>
<span><span class="va">out</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">k</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">out</span>, col <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html" class="external-link">sf.colors</a></span><span class="op">(</span><span class="va">nclus</span>, categorical<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">## downsample set to 18</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">m</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="stars7_files/figure-html/unnamed-chunk-18-1.png" width="700"></p>
<p>we see that class 1 and 3 identify with the unclouded area, 3 with
land, the other classes seem to mainly catch aspects of the cloud
signal.</p>
</div>
</div>
<div class="section level2">
<h2 id="supervised-learners">Supervised learners<a class="anchor" aria-label="anchor" href="#supervised-learners"></a>
</h2>
<div class="section level3">
<h3 id="random-forest-land-use-classification">Random Forest land use classification<a class="anchor" aria-label="anchor" href="#random-forest-land-use-classification"></a>
</h3>
<p>The following example is purely for educational purposes; the
classified “land use” is just a rough approximation from what seems to
be easily visible on the image: sea, land, and areas with both but
partially covered by clouds. We opted therefore for four classes: sea,
land, clouds over sea, clouds over land.</p>
<p>We have polygon areas where the land use was classified, residing in
a GeoPackage file. (This file was created using QGIS, using the
instructions found <a href="https://www.qgistutorials.com/en/docs/digitizing_basics.html" class="external-link">here</a>.)</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># for all, multi-resolution, use:</span></span>
<span><span class="va">bands</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"B04"</span>, <span class="st">"B03"</span>, <span class="st">"B02"</span>, <span class="st">"B08"</span>, <span class="st">"B01"</span>, <span class="st">"B05"</span>, <span class="st">"B06"</span>, <span class="st">"B07"</span>, <span class="st">"B8A"</span>, <span class="st">"B09"</span>, <span class="st">"B10"</span>, <span class="st">"B11"</span>, <span class="st">"B12"</span><span class="op">)</span></span>
<span><span class="co"># bands = c("B04", "B03", "B02", "B08")</span></span>
<span><span class="va">s2</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"/vsizip/"</span>, <span class="va">granule</span>, </span>
<span><span class="st">"/S2A_MSIL1C_20180220T105051_N0206_R051_T32ULE_20180221T134037.SAFE/GRANULE/L1C_T32ULE_A013919_20180220T105539/IMG_DATA/T32ULE_20180220T105051_"</span>, <span class="va">bands</span>, <span class="st">".jp2"</span><span class="op">)</span></span>
<span><span class="va">r</span> <span class="op">=</span> <span class="fu"><a href="../reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">s2</span>, proxy <span class="op">=</span> <span class="cn">TRUE</span>, NA_value <span class="op">=</span> <span class="fl">0</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="va">bands</span><span class="op">)</span> </span>
<span><span class="va">cl</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html" class="external-link">read_sf</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"gpkg/s2.gpkg"</span>, package <span class="op">=</span> <span class="st">"stars"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html" class="external-link">st_crs</a></span><span class="op">(</span><span class="va">r</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">r</span>, reset <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">## downsample set to 8</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">cl</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">m</span>, add <span class="op">=</span> <span class="cn">TRUE</span>, border <span class="op">=</span> <span class="st">'orange'</span><span class="op">)</span></span></code></pre></div>
<p><img src="stars7_files/figure-html/unnamed-chunk-19-1.png" width="700"></p>
<p>Next, we need points, sampled inside these polygons, for which we
need to extract the satellite spectral data</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pts</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_sample.html" class="external-link">st_sample</a></span><span class="op">(</span><span class="va">cl</span>, <span class="fl">1000</span>, <span class="st">"regular"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_binary_ops.html" class="external-link">st_intersection</a></span><span class="op">(</span><span class="va">cl</span><span class="op">)</span></span>
<span><span class="co">## Warning: attribute variables are assumed to be spatially constant throughout</span></span>
<span><span class="co">## all geometries</span></span>
<span><span class="va">train</span> <span class="op">=</span> <span class="fu"><a href="../reference/st_extract.html">st_extract</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">pts</span><span class="op">)</span></span>
<span><span class="va">train</span><span class="op">$</span><span class="va">use</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">as.factor</a></span><span class="op">(</span><span class="va">pts</span><span class="op">$</span><span class="va">use</span><span class="op">)</span> <span class="co"># no need for join, since the order did not change</span></span>
<span><span class="va">train</span></span>
<span><span class="co">## Simple feature collection with 1000 features and 14 fields</span></span>
<span><span class="co">## Geometry type: POINT</span></span>
<span><span class="co">## Dimension:     XY</span></span>
<span><span class="co">## Bounding box:  xmin: 328195.1 ymin: 5909563 xmax: 407928.8 ymax: 5970391</span></span>
<span><span class="co">## Projected CRS: WGS 84 / UTM zone 32N</span></span>
<span><span class="co">## First 10 features:</span></span>
<span><span class="co">##     B04  B03  B02  B08  B01  B05  B06  B07  B8A  B09 B10  B11  B12</span></span>
<span><span class="co">## 1   921 1139 1396 2375 1744 1180 1860 2099 2396 1006  15 1458  779</span></span>
<span><span class="co">## 2   879 1136 1366 2935 1728 1246 2148 2537 2814  994  14 1669  887</span></span>
<span><span class="co">## 3   870 1029 1338 1872 1694 1076 1567 1765 2042  824  14 1629  856</span></span>
<span><span class="co">## 4  1016 1228 1439 3054 1789 1477 2655 3057 3427 1207  15 2220 1210</span></span>
<span><span class="co">## 5  1010 1145 1449 2039 1782 1302 1724 1975 2144  860  10 1795  999</span></span>
<span><span class="co">## 6  1344 1213 1475 1943 1770 1427 1684 1901 2143  863  14 2276 1365</span></span>
<span><span class="co">## 7  1067 1204 1472 2348 1778 1369 2057 2306 2685 1032  17 2010 1179</span></span>
<span><span class="co">## 8  1035 1144 1437 2289 1760 1299 1891 2246 2637 1042  11 1788  920</span></span>
<span><span class="co">## 9   854 1047 1371 1902 1715 1146 1815 1941 2133  782  16 1568  949</span></span>
<span><span class="co">## 10  941 1155 1379 2802 1689 1380 2268 2595 2976 1058  15 2012 1086</span></span>
<span><span class="co">##                           x  use</span></span>
<span><span class="co">## 1  POINT (394518.2 5940525) land</span></span>
<span><span class="co">## 2  POINT (390045.1 5931738) land</span></span>
<span><span class="co">## 3  POINT (390340.9 5929888) land</span></span>
<span><span class="co">## 4    POINT (391254 5938829) land</span></span>
<span><span class="co">## 5  POINT (391997.7 5937843) land</span></span>
<span><span class="co">## 6  POINT (395680.9 5933296) land</span></span>
<span><span class="co">## 7  POINT (388792.2 5934807) land</span></span>
<span><span class="co">## 8  POINT (392185.2 5940074) land</span></span>
<span><span class="co">## 9  POINT (387142.8 5936359) land</span></span>
<span><span class="co">## 10 POINT (390877.6 5927178) land</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://www.stat.berkeley.edu/~breiman/RandomForests/" class="external-link">randomForest</a></span><span class="op">)</span></span>
<span><span class="co">## randomForest 4.7-1.1</span></span>
<span><span class="co">## Type rfNews() to see new features/changes/bug fixes.</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## Attaching package: 'randomForest'</span></span>
<span><span class="co">## The following object is masked from 'package:dplyr':</span></span>
<span><span class="co">## </span></span>
<span><span class="co">##     combine</span></span>
<span><span class="va">train</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span><span class="va">train</span><span class="op">)</span></span>
<span><span class="va">train</span><span class="op">$</span><span class="va">x</span> <span class="op">=</span> <span class="cn">NULL</span> <span class="co"># remove geometry</span></span>
<span><span class="va">rf</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/randomForest/man/randomForest.html" class="external-link">randomForest</a></span><span class="op">(</span><span class="va">use</span> <span class="op">~</span> <span class="va">.</span>, <span class="va">train</span><span class="op">)</span> <span class="co"># ~ . : use all other attributes</span></span>
<span><span class="va">pr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">r</span>, <span class="va">rf</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">pr</span>, reset <span class="op">=</span> <span class="cn">FALSE</span>, key.pos <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">## downsample set to 8</span></span>
<span><span class="co"># add country outline:</span></span>
<span><span class="fu"><a href="../reference/plot.html">plot</a></span><span class="op">(</span><span class="va">m</span>, add <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p><img src="stars7_files/figure-html/unnamed-chunk-21-1.png" width="700"></p>
<p>This comes with the rather trivial finding that land and sea can be
well predicted when there are no clouds, and the less trivial finding
that they can be reasonably distinguished through patchy clouds of this
kind. Note that predictions of this kind are pure pixel-based: for each
prediction only the spectral bands for this pixel are considered, not
for instance of any neighboring pixels.</p>
</div>
</div>
<div class="section level2">
<h2 id="parallel-processing">Parallel processing<a class="anchor" aria-label="anchor" href="#parallel-processing"></a>
</h2>
<p>Some machine learning models support multithreading by default (e.g.,
<code>ranger</code> and <code>xgboost</code>), but this is not the rule.
R is single-threaded, but using appropriate packages we can easily
parallelize the calculations, which will reduce the data processing
time. An example tutorial showing step-by-step unsupervised
classification using multithreading can be found on the <a href="https://r-spatial.org/r/2023/09/21/stars-parallel.html" class="external-link">R-Spatial
blog</a>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Edzer Pebesma.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
