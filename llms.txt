# Spatiotemporal Arrays: Raster and Vector Datacubes

Spatiotemporal data often comes in the form of dense arrays, with space
and time being array dimensions. Examples include

- socio-economic or demographic data,
- environmental variables monitored at fixed stations,
- raster maps,
- time series of satellite images with multiple spectral bands,
- spatial simulations, and
- climate or weather model output.

This R package provides classes and methods for reading, manipulating,
plotting and writing such data cubes, to the extent that there are
proper formats for doing so.

## Raster and vector data cubes

The canonical data cube most of us have in mind is that where two
dimensions represent spatial raster dimensions, and the third time (or
band), as e.g. shown here:

![](https://raw.githubusercontent.com/r-spatial/stars/main/images/cube1.png)

By data cubes however we also consider higher-dimensional cubes
(hypercubes) such as a five-dimensional cube where in addition to time,
spectral band and sensor form dimensions:

![](https://raw.githubusercontent.com/r-spatial/stars/main/images/cube2.png)

or lower-dimensional cubes such as a raster image:

``` r
library(dplyr)
library(stars)
tif = system.file("tif/L7_ETMs.tif", package = "stars")
read_stars(tif) |>
  slice(index = 1, along = "band") |>
  plot()
```

![](reference/figures/README-plot1-1.png)

Raster data do not need to be regular and aligned with North/East, and
package `stars` supports besides *regular* also *rotated*, *sheared*,
*rectilinear* and *curvilinear* rasters:

![](reference/figures/README-plot2-1.png)

Vector data cubes arise when we do not have two regularly discretized
spatial dimensions, but a single dimension that points to distinct
spatial feature geometries, such as polygons (e.g. denoting
administrative regions):

![](https://raw.githubusercontent.com/r-spatial/stars/main/images/cube3.png)

or points (e.g. denoting sensor locations):

![](https://raw.githubusercontent.com/r-spatial/stars/main/images/cube4.png)

NetCDF’s CF-convention calls this a [discrete
axis](https://cfconventions.org/Data/cf-conventions/cf-conventions-1.8/cf-conventions.html#discrete-axis).

## NetCDF, GDAL

`stars` provides two functions to read data: `read_ncdf` and
`read_stars`, where the latter reads through GDAL. (In the future, both
will be integrated in `read_stars`.) For reading NetCDF files, package
`RNetCDF` is used, for reading through GDAL, package `sf` provides the
binary linking to GDAL.

For vector and raster operations, `stars` uses as much as possible the
routines available in GDAL and PROJ (e.g. `st_transform`, `rasterize`,
`polygonize`, `warp`). Read more about this in the vignette on
[vector-raster conversions, reprojection,
warping](https://r-spatial.github.io/stars/articles/stars5.html).

## Out-of-memory (on-disk) rasters

Package `stars` provides `stars_proxy` objects (currently only when read
through GDAL), which contain only the dimensions metadata and pointers
to the files on disk. These objects work lazily: reading and processing
data is postponed to the moment that pixels are really needed (at plot
time, or when writing to disk), and is done at the lowest spatial
resolution possible that still fulfills the resolution of the graphics
device. More details are found in the [stars proxy
vignette](https://r-spatial.github.io/stars/articles/stars2.html).

The following methods are currently available for `stars_proxy` objects:

``` r
methods(class = "stars_proxy")
#  [1] [               [[<-            [<-             adrop          
#  [5] aggregate       aperm           as.data.frame   c              
#  [9] coerce          dim             droplevels      filter         
# [13] hist            image           initialize      is.na          
# [17] Math            merge           mutate          Ops            
# [21] plot            prcomp          predict         print          
# [25] pull            rename          select          show           
# [29] slice           slotsFromS3     split           st_apply       
# [33] st_as_sf        st_as_stars     st_crop         st_dimensions<-
# [37] st_downsample   st_mosaic       st_normalize    st_redimension 
# [41] st_sample       st_set_bbox     transmute       write_stars    
# see '?methods' for accessing help and source code
```

## Raster and vector time series analysis example

In the following, a curvilinear grid with hourly precipitation values of
a hurricane is imported and the first 12 time steps are plotted:

``` r
prec_file = system.file("nc/test_stageiv_xyt.nc", package = "stars")
(prec = read_stars(gdal_subdatasets(prec_file)[[1]]))
# stars object with 3 dimensions and 1 attribute
# attribute(s):
#                                         Min. 1st Qu. Median     Mean 3rd Qu.
# Total_precipitation_surface... [kg/m^2]    0       0   0.75 4.143009    4.63
#                                           Max.
# Total_precipitation_surface... [kg/m^2] 163.75
# dimension(s):
#      from  to                  offset   delta  refsys
# x       1  87                      NA      NA  WGS 84
# y       1 118                      NA      NA  WGS 84
# time    1  23 2018-09-13 19:00:00 UTC 1 hours POSIXct
#                                  values x/y
# x    [87x118] -80.61 [°],...,-74.88 [°] [x]
# y      [87x118] 32.44 [°],...,37.62 [°] [y]
# time                               NULL    
# curvilinear grid
# or: (prec = read_ncdf(prec_file, curvilinear = c("lon", "lat"), ignore_bounds = TRUE))
sf::read_sf(system.file("gpkg/nc.gpkg", package = "sf"), "nc.gpkg") |> 
  st_transform(st_crs(prec)) -> nc # transform from NAD27 to WGS84
nc_outline = st_union(st_geometry(nc))
plot_hook = function() plot(nc_outline, border = 'red', add = TRUE)
prec |>
  slice(index = 1:12, along = "time") |>
  plot(downsample = c(3, 3, 1), hook = plot_hook)
```

![](reference/figures/README-plot3-1.png)

and next, intersected with with the counties of North Carolina, where
the maximum precipitation intensity was obtained per county, and
plotted:

``` r
a = aggregate(prec, by = nc, FUN = max)
plot(a, max.plot = 23, border = 'grey', lwd = .5)
```

![](reference/figures/README-plot4-1.png)

We can integrate over (reduce) time, for instance to find out *when* the
maximum precipitation occurred. The following code finds the time index,
and then the corresponding time value:

``` r
index_max = function(x) ifelse(all(is.na(x)), NA, which.max(x))
b = st_apply(a, "geom", index_max)
b |> mutate(when = st_get_dimension_values(a, "time")[b$index_max]) |>
  select(when) |>
  plot(key.pos = 1, main = "time of maximum precipitation")
```

![](reference/figures/README-plot5-1.png)

With package `cubble`, we can make a glyph map to see the magnitude and
timings of county maximum precipitation:

``` r
library(cubble)
library(ggplot2)
a |> setNames("precip") |>
  st_set_dimensions(2, name = "tm") |>
  units::drop_units() |>
  as_cubble(key = id, index = tm) -> a.cb
a.cb |>
  face_temporal() |>
  unfold(long, lat) |>
  mutate(tm = as.numeric(tm)) |>
  ggplot(aes(x_major = long, x_minor = tm, y_major = lat, y_minor = precip)) +
  geom_sf(data = nc, inherit.aes = FALSE) +
  geom_glyph_box(width = 0.3, height = 0.1) +
  geom_glyph(width = 0.3, height = 0.1)
```

![](reference/figures/README-plot6-1.png)

## Other packages for data cubes

### [`gdalcubes`](https://github.com/appelmar/gdalcubes)

Package `gdalcubes` can be used to create data cubes (or functions from
them) from image collections, sets of multi-band images with varying

- spatial resolution
- spatial extent
- coordinate reference systems (e.g., spread over multiple UTM zones)
- observation times

and does this by resampling and/or aggregating over space and/or time.
It reuses GDAL VRT’s and gdalwarp for spatial resampling and/or warping,
and handles temporal resampling or aggregation itself.

### [`ncdfgeom`](https://github.com/DOI-USGS/ncdfgeom)

`ncdfgeom` reads and writes vector data cubes from and to netcdf files
in a standards-compliant way.

### [`raster`](https://github.com/rspatial/raster/) and [`terra`](https://github.com/rspatial/terra/)

Packages `raster` and its successor, `terra` are powerful packages for
handling raster maps and stacks of raster maps both in memory and on
disk, but do not address

- non-raster time series,
- multi-attribute rasters time series
- rasters with mixed type attributes (e.g., numeric, logical, factor,
  POSIXct)
- rectilinear or curvilinear rasters

A list of `stars` commands matching existing `raster` commands is found
in this
[wiki](https://github.com/r-spatial/stars/wiki/How-%60raster%60-functions-map-to-%60stars%60-functions).
A list of translations in the opposite direction (from `stars` to
`raster` or `terra`) still needs to be made.

A comment on the differences between `stars` and `terra` is found
[here](https://github.com/r-spatial/stars/issues/633).

## Other `stars` resources:

- blog posts: [first](https://r-spatial.org/r/2017/11/23/stars1.html),
  [second](https://r-spatial.org/r/2018/03/22/stars2.html),
  [third](https://r-spatial.org/r/2018/03/23/stars3.html), and [newer
  blog posts](https://r-spatial.org/)
- [vignettes](https://r-spatial.github.io/stars/articles/)
- the original [R Consortium
  proposal](https://github.com/r-spatial/stars/blob/main/PROPOSAL.md).

### Acknowledgment

This project has been realized with financial
[support](https://www.r-consortium.org/blog/2017/04/03/q1-2017-isc-grants)
from the

[![](https://r-consortium.org/images/RConsortium_Horizontal_Pantone.webp)](https://r-consortium.org/all-projects/2017-group-1.html#stars-scalable-spatiotemporal-tidy-arrays-for-r)

# Package index

## All functions

- [`L7_ETMs`](L7_ETMs.md) : Landsat-7 bands for a selected region around
  Olinda, BR
- [`aggregate(`*`<stars>`*`)`](aggregate.stars.md) : spatially or
  temporally aggregate stars object
- [`bcsd_obs`](bcsd_obs.md) : Monthly Gridded Meteorological
  Observations
- [`c(`*`<stars_proxy>`*`)`](c.stars.md)
  [`c(`*`<stars>`*`)`](c.stars.md) : combine multiple stars objects, or
  combine multiple attributes in a single stars object into a single
  array
- [`as`](coerce-methods.md)
  [`coerce,stars,Raster-method`](coerce-methods.md)
  [`coerce,stars_proxy,Raster-method`](coerce-methods.md)
  [`coerce,stars,Terra-method`](coerce-methods.md)
  [`coerce,stars_proxy,Terra-method`](coerce-methods.md) : Coerce stars
  object into a Raster raster or brick
- [`contour(`*`<stars>`*`)`](contour.stars.md) : plot contours of a
  stars object
- [`cut(`*`<array>`*`)`](cut_stars.md)
  [`cut(`*`<matrix>`*`)`](cut_stars.md)
  [`cut(`*`<stars>`*`)`](cut_stars.md) : cut methods for stars objects
- [`filter.stars()`](dplyr.md) [`filter.stars_proxy()`](dplyr.md)
  [`mutate.stars()`](dplyr.md) [`mutate.stars_proxy()`](dplyr.md)
  [`transmute.stars()`](dplyr.md) [`transmute.stars_proxy()`](dplyr.md)
  [`select.stars()`](dplyr.md) [`select.stars_proxy()`](dplyr.md)
  [`rename.stars()`](dplyr.md) [`rename.stars_proxy()`](dplyr.md)
  [`pull.stars()`](dplyr.md) [`pull.stars_proxy()`](dplyr.md)
  [`as.tbl_cube.stars()`](dplyr.md) [`slice.stars()`](dplyr.md)
  [`slice.stars_proxy()`](dplyr.md) [`replace_na.stars()`](dplyr.md)
  [`replace_na.stars_proxy()`](dplyr.md) : dplyr verbs for stars objects
- [`expand_dimensions()`](expand_dimensions.md) : expand the dimension
  values into a list
- [`geom_stars()`](geom_stars.md) [`theme_stars()`](geom_stars.md) :
  ggplot geom for stars objects
- [`` `%in%`( ``*`<stars>`*`)`](in-methods.md) : evaluate whether cube
  values are in a given set
- [`make_intervals()`](make_intervals.md) : create an intervals object
- [`read_mdim()`](mdim.md) [`write_mdim()`](mdim.md) : Read or write
  data using GDAL's multidimensional array API
- [`split(`*`<stars>`*`)`](merge.md) [`merge(`*`<stars>`*`)`](merge.md)
  : merge or split stars object
- [`Ops(`*`<stars>`*`)`](ops_stars.md)
  [`Math(`*`<stars>`*`)`](ops_stars.md)
  [`Ops(`*`<stars_proxy>`*`)`](ops_stars.md)
  [`Math(`*`<stars_proxy>`*`)`](ops_stars.md) : S3 Ops Group Generic
  Functions for stars objects
- [`plot(`*`<nc_proxy>`*`)`](plot.md) [`plot(`*`<stars>`*`)`](plot.md)
  [`image(`*`<stars>`*`)`](plot.md)
  [`plot(`*`<stars_proxy>`*`)`](plot.md) : plot stars object, with
  subplots for each level of first non-spatial dimension
- [`prcomp(`*`<stars_proxy>`*`)`](prcomp.md)
  [`prcomp(`*`<stars>`*`)`](prcomp.md) : Principle components of stars
  object
- [`predict(`*`<stars_proxy>`*`)`](predict.stars.md)
  [`predict(`*`<stars>`*`)`](predict.stars.md) : Predict values, given a
  model object, for a stars or stars_proxy object
- [`as.data.frame(`*`<dimensions>`*`)`](print_stars.md)
  [`print(`*`<dimensions>`*`)`](print_stars.md)
  [`print(`*`<stars>`*`)`](print_stars.md) : print stars or dimensions
  object
- [`read_ncdf()`](read_ncdf.md) : Read NetCDF into stars object
- [`read_stars()`](read_stars.md) : read raster/array dataset from file
  or connection
- [`st_redimension()`](redimension.md) : redimension array, or collapse
  attributes into a new dimension
- [`st_apply(`*`<stars>`*`)`](st_apply.md) : st_apply apply a function
  to one or more array dimensions
- [`st_as_sfc(`*`<stars>`*`)`](st_as_sf.md)
  [`st_as_sf(`*`<stars>`*`)`](st_as_sf.md)
  [`st_as_sf(`*`<stars_proxy>`*`)`](st_as_sf.md) : Convert stars object
  into an sf object
- [`st_as_stars()`](st_as_stars.md) : convert objects into a stars
  object
- [`st_cells()`](st_cells.md) : return the cell index corresponding to
  the location of a set of points
- [`st_contour()`](st_contour.md) : Compute or plot contour lines or
  sets
- [`st_coordinates(`*`<stars>`*`)`](st_coordinates.md)
  [`as.data.frame(`*`<stars>`*`)`](st_coordinates.md)
  [`as_tibble.stars()`](st_coordinates.md) : retrieve coordinates for
  raster or vector cube cells
- [`st_crop(`*`<mdim>`*`)`](st_crop.md)
  [`st_crop(`*`<stars_proxy>`*`)`](st_crop.md)
  [`st_crop(`*`<stars>`*`)`](st_crop.md) : crop a stars object
- [`st_dim_to_attr()`](st_dim_to_attr.md) : create an array with
  dimension values
- [`st_dimensions()`](st_dimensions.md)
  [`` `st_dimensions<-`() ``](st_dimensions.md)
  [`st_set_dimensions()`](st_dimensions.md)
  [`st_get_dimension_values()`](st_dimensions.md) : get dimensions from
  stars object
- [`st_downsample()`](st_downsample.md) : downsample stars or
  stars_proxy objects
- [`st_extract()`](st_extract.md) : Extract cell values at point
  locations
- [`st_geotransform()`](st_geotransform.md)
  [`` `st_geotransform<-`() ``](st_geotransform.md) : get or set the
  geotransform, or rotation matrix
- [`st_intersects(`*`<stars>`*`)`](st_intersects.stars.md) : spatial
  intersect predicate for stars and sfc object
- [`st_join(`*`<stars>`*`)`](st_join.stars.md) : Spatially join a stars
  and an \`sf\` object
- [`st_mosaic()`](st_mosaic.md) : build mosaic (composite) of several
  spatially disjoint stars objects
- [`st_raster_type()`](st_raster_type.md) : get the raster type (if any)
  of a stars object
- [`st_rasterize()`](st_rasterize.md) : rasterize simple feature
  geometries
- [`st_res()`](st_res.md) : obtain (spatial) resolution of a stars
  object
- [`st_rgb()`](st_rgb.md) : reduce dimension to rgb (alpha) hex values
- [`st_rotate(`*`<stars>`*`)`](st_rotate.md)
  [`st_rotate(`*`<sfc>`*`)`](st_rotate.md)
  [`st_rotate(`*`<sf>`*`)`](st_rotate.md) : Transform rotated pole
  long/lat regular grid to unrotated curvilinear grid
- [`st_set_bbox()`](st_set_bbox.md) : set bounding box parameters of
  regular grid
- [`st_tile()`](st_tile.md) : Specify parameters to load raster in
  blocks
- [`st_transform(`*`<stars>`*`)`](st_transform.md)
  [`st_transform_proj.stars()`](st_transform.md) : transform geometries
  in stars objects to a new coordinate reference system, without warping
- [`st_warp()`](st_warp.md) : Warp (resample) grids in stars objects to
  a new grid, possibly in an new coordinate reference system
- [`st_xy2sfc()`](st_xy2sfc.md) [`st_sfc2xy()`](st_xy2sfc.md) : replace
  x y raster dimensions with simple feature geometry list (points, or
  polygons = rasterize) and vice versa
- [`stars_sentinel2`](stars_sentinel2.md) : Sentinel-2 sample tile
- [`` `[<-`( ``*`<stars_proxy>`*`)`](stars_subset.md)
  [`` `[`( ``*`<stars>`*`)`](stars_subset.md)
  [`` `[<-`( ``*`<stars>`*`)`](stars_subset.md)
  [`st_flip()`](stars_subset.md) : subset stars objects
- [`write_stars()`](write_stars.md) [`detect.driver()`](write_stars.md)
  : write stars object to gdal dataset (typically: to file)

# Articles

### All vignettes

- [1. introduction](stars1.md):
- [2. stars proxy objects](stars2.md):
- [3. stars tidyverse methods](stars3.md):
- [4. stars data model](stars4.md):
- [5. vector-raster conversions, reprojection, warping](stars5.md):
- [6. How \`raster\` functions map to \`stars\` functions](stars6.md):
- [7. Statistical modelling with stars objects](stars7.md):
- [8. NetCDF Proxy Workflows](stars8.md):
