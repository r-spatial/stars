
R version 4.0.2 (2020-06-22) -- "Taking Off Again"
Copyright (C) 2020 The R Foundation for Statistical Computing
Platform: x86_64-pc-linux-gnu (64-bit)

R is free software and comes with ABSOLUTELY NO WARRANTY.
You are welcome to redistribute it under certain conditions.
Type 'license()' or 'licence()' for distribution details.

R is a collaborative project with many contributors.
Type 'contributors()' for more information and
'citation()' on how to cite R or R packages in publications.

Type 'demo()' for some demos, 'help()' for on-line help, or
'help.start()' for an HTML browser interface to help.
Type 'q()' to quit R.

> library(stars)
Loading required package: abind
Loading required package: sf
Linking to GEOS 3.8.0, GDAL 3.0.4, PROJ 7.0.0
> 
> library(spacetime)
> data(air) # this loads several datasets in .GlobalEnv
> dim(air)
space  time 
   70  4383 
> d = st_dimensions(station = st_set_crs(st_as_sfc(stations), 4326), time = dates)
> 
> blocks = st_make_grid(st_as_sfc("POLYGON ((5.871619 47.26986, 15.03811 47.26986, 15.03811 55.05653, 5.871619 55.05653, 5.871619 47.26986))", crs = 4326),
+ 	n = c(3,3))
> 
> (aq = st_as_stars(list(PM10 = air), dimensions = d))
stars object with 2 dimensions and 1 attribute
attribute(s):
     PM10        
 Min.   :  0.00  
 1st Qu.:  9.92  
 Median : 14.79  
 Mean   : 17.70  
 3rd Qu.: 21.99  
 Max.   :274.33  
 NA's   :157659  
dimension(s):
        from   to     offset  delta refsys point
station    1   70         NA     NA WGS 84  TRUE
time       1 4383 1998-01-01 1 days   Date FALSE
                                                         values
station POINT (9.585911 53.67057),...,POINT (9.446661 49.24068)
time                                                       NULL
> (a = aggregate(aq, blocks, mean, na.rm = TRUE))
stars object with 2 dimensions and 1 attribute
attribute(s):
     PM10        
 Min.   :  1.00  
 1st Qu.: 11.00  
 Median : 15.57  
 Mean   : 18.17  
 3rd Qu.: 22.17  
 Max.   :183.27  
 NA's   :8429    
dimension(s):
         from   to     offset  delta refsys point
geometry    1    9         NA     NA WGS 84 FALSE
time        1 4383 1998-01-01 1 days   Date FALSE
                                                                    values
geometry POLYGON ((5.871619 47.26986...,...,POLYGON ((11.98261 52.46097...
time                                                                  NULL
> 
> # adapted from ?read_stars:
> m = array(1:720, dim = c(x = 10, y = 12, t = 6)) # named dim
> st = st_as_stars(m)
> attr(st, "dimensions")$y$delta = -1
> attr(st, "dimensions")$y$offset = 12
> tm = as.Date("2019-02-19") + 1:6
> st = st_set_crs(st_set_dimensions(st, 3, values = tm), 4326)
> 
> tmp = tempfile(fileext = ".tif")
> write_stars(st, tmp)
> 
> (red <- read_stars(tmp, RasterIO = list(nXOff = 1, nYOff = 1, nXsize = 10, nYSize = 12,
+    nBufXSize = 2, nBufYSize = 2)))
stars object with 3 dimensions and 1 attribute
attribute(s):
 file52bf1cf84504.tif 
 Min.   : 33.0        
 1st Qu.:199.2        
 Median :365.5        
 Mean   :365.5        
 3rd Qu.:531.8        
 Max.   :698.0        
dimension(s):
     from to offset delta refsys point values x/y
x       1  2      0     5 WGS 84 FALSE   NULL [x]
y       1  2     12    -6 WGS 84 FALSE   NULL [y]
band    1  6     NA    NA     NA    NA   NULL    
> 
> sfc = st_set_crs(st_as_sfc(red, as_points = FALSE), st_crs(st))
> (a = aggregate(st, sfc, mean))
stars object with 2 dimensions and 1 attribute
attribute(s):
      A1        
 Min.   : 28.0  
 1st Qu.:194.2  
 Median :360.5  
 Mean   :360.5  
 3rd Qu.:526.8  
 Max.   :693.0  
dimension(s):
         from to     offset  delta refsys point
geometry    1  4         NA     NA WGS 84 FALSE
t           1  6 2019-02-20 1 days   Date FALSE
                                                                    values
geometry POLYGON ((0 12, 5 12, 5 6, ...,...,POLYGON ((5 6, 10 6, 10 0, ...
t                                                                     NULL
> a[[1]]
     [,1] [,2] [,3] [,4] [,5] [,6]
[1,]   28  148  268  388  508  628
[2,]   33  153  273  393  513  633
[3,]   88  208  328  448  568  688
[4,]   93  213  333  453  573  693
> sum(a[[1]])*30 == sum(1:720)
[1] TRUE
> 
> tm0 = as.Date("2019-02-19") + -1:8
> (a = aggregate(st, tm0, mean, na.rm = TRUE))
stars object with 3 dimensions and 1 attribute
attribute(s):
      A1        
 Min.   :  1.0  
 1st Qu.:180.8  
 Median :360.5  
 Mean   :360.5  
 3rd Qu.:540.2  
 Max.   :720.0  
 NA's   :480    
dimension(s):
     from to     offset  delta refsys point values x/y
time    1 10 2019-02-18 1 days   Date    NA   NULL    
x       1 10          0      1 WGS 84 FALSE   NULL [x]
y       1 12         12     -1 WGS 84 FALSE   NULL [y]
> 
> # with "by" geometry not overlapping x
> pt = st_point(c(-10,-10))
> (sfc = c(sfc, st_sfc(pt, crs = st_crs(sfc))))
Geometry set for 5 features 
geometry type:  GEOMETRY
dimension:      XY
bbox:           xmin: -10 ymin: -10 xmax: 10 ymax: 12
geographic CRS: WGS 84
POLYGON ((0 12, 5 12, 5 6, 0 6, 0 12))
POLYGON ((5 12, 10 12, 10 6, 5 6, 5 12))
POLYGON ((0 6, 5 6, 5 0, 0 0, 0 6))
POLYGON ((5 6, 10 6, 10 0, 5 0, 5 6))
POINT (-10 -10)
> (a = aggregate(st, sfc, mean))
stars object with 2 dimensions and 1 attribute
attribute(s):
      A1        
 Min.   : 28.0  
 1st Qu.:194.2  
 Median :360.5  
 Mean   :360.5  
 3rd Qu.:526.8  
 Max.   :693.0  
 NA's   :6      
dimension(s):
         from to     offset  delta refsys point
geometry    1  5         NA     NA WGS 84 FALSE
t           1  6 2019-02-20 1 days   Date FALSE
                                                     values
geometry POLYGON ((0 12, 5 12, 5 6, ...,...,POINT (-10 -10)
t                                                      NULL
> 
> (a = aggregate(st, st, mean))
stars object with 2 dimensions and 1 attribute
attribute(s):
      A1        
 Min.   :  1.0  
 1st Qu.:180.8  
 Median :360.5  
 Mean   :360.5  
 3rd Qu.:540.2  
 Max.   :720.0  
dimension(s):
         from  to     offset  delta refsys point
geometry    1 120         NA     NA WGS 84 FALSE
t           1   6 2019-02-20 1 days   Date FALSE
                                                                    values
geometry POLYGON ((0 12, 1 12, 1 11,...,...,POLYGON ((9 1, 10 1, 10 0, ...
t                                                                     NULL
> 
> proc.time()
   user  system elapsed 
  1.406   0.073   1.467 
